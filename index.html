
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Log√≠stica & Almac√©n ‚Äî Sistema de Pedidos</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{ --ink:#0b3a55; --brand:#0ea5e9; --brand2:#2563eb; }
    body{background:#f5f7fb;color:#0f172a}
    .navbar{background:#0f172a;color:#e5eef9}
    .kpi{background:#fff;border:1px solid #e5e7eb;border-radius:0.8rem;padding:.9rem 1rem}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:0.8rem}
    .btn{background:var(--brand);color:#fff;border-radius:.55rem;padding:.5rem .9rem}
    .btn:hover{filter:brightness(.97)}
    .tab{border:1px solid #e5e7eb;border-radius:.6rem;padding:.45rem .8rem;background:#fff;cursor:pointer}
    .tab.active{background:#0ea5e9;color:#fff;border-color:#0ea5e9}
    .chip{border:1px solid #e5e7eb;border-radius:9999px;padding:.25rem .6rem;background:#fff;cursor:pointer}
    .chip.active{background:#2563eb;color:#fff;border-color:#2563eb}
    .badge{background:#eef6ff;border:1px solid #dbeafe;color:#0b3a55;border-radius:9999px;padding:2px 10px;font-size:12px}
    #map{height:55vh;border-radius:.8rem;border:1px solid #e5e7eb}
    .toast{position:fixed;right:1rem;bottom:1rem;background:#fee2e2;color:#7f1d1d;border:1px solid #fecaca;border-radius:.6rem;padding:.6rem .8rem;display:none;z-index:9999}
    .toast.show{display:block}
    .table th{font-size:.8rem;text-transform:uppercase;color:#334155;background:#f3f4f6}
    .table td{border-top:1px solid #f1f5f9}
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="max-w-7xl mx-auto flex items-center justify-between p-3">
      <div class="flex items-center gap-3">
        <img src="./logo.png" alt="Logo" class="h-8 w-8 object-contain rounded">
        <div class="text-lg font-semibold">Log√≠stica & Almac√©n</div>
      </div>
      <button id="refreshBtn" class="btn">Actualizar</button>
    </div>
  </nav>

  <header class="bg-white border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4 py-5">
      <h1 class="text-2xl font-bold" style="color:var(--ink)">Sistema de Gesti√≥n de Pedidos</h1>
      <p class="text-sm text-gray-500">Almac√©n y log√≠stica</p>
    </div>
  </header>

  <main class="max-w-7xl mx-auto p-4 space-y-4">
    <section class="grid md:grid-cols-4 gap-3">
      <div class="kpi">Pendientes <div class="text-2xl font-semibold" id="kpiPendientes">‚Äî</div></div>
      <div class="kpi">Hoy <div class="text-2xl font-semibold" id="kpiHoy">‚Äî</div></div>
      <div class="kpi">En ruta <div class="text-2xl font-semibold" id="kpiRuta">‚Äî</div></div>
      <div class="kpi">Entregados 7d <div class="text-2xl font-semibold" id="kpiEntregados">‚Äî</div></div>
    </section>

    <section class="card p-3">
      <div class="flex flex-wrap items-center gap-2">
        <div class="tab active" data-tab="todos">Todos</div>
        <div class="tab" data-tab="pendientes">Pendientes</div>
        <div class="tab" data-tab="facturados">Facturados</div>
        <div class="tab" data-tab="entregados">Entregados</div>

        <div class="ml-4 flex items-center gap-2 text-sm">
          <span>Empresa:</span>
          <span class="chip active" data-empresa="">Todas</span>
          <span class="chip" data-empresa="karaka">karaka</span>
          <span class="chip" data-empresa="distribuidora">distribuidora</span>
        </div>

        <div class="ml-4 flex items-center gap-2 text-sm">
          <label for="selVendedor" class="text-gray-600">Vendedor:</label>
          <select id="selVendedor" class="border border-gray-300 rounded-md px-3 py-1 bg-white">
            <option value="">Todos</option>
          </select>
          <label for="selGestor" class="text-gray-600 ml-2">Gestor:</label>
          <select id="selGestor" class="border border-gray-300 rounded-md px-3 py-1 bg-white">
            <option value="">Todos</option>
          </select>
        </div>

        <div class="ml-auto flex items-center gap-2">
          <input id="q" type="search" placeholder="Buscar pedido/cliente/estado" class="border border-gray-300 rounded-md px-3 py-1 w-64 bg-white">
          <input id="fDesde" type="date" class="border border-gray-300 rounded-md px-3 py-1 bg-white">
          <input id="fHasta" type="date" class="border border-gray-300 rounded-md px-3 py-1 bg-white">
        </div>
      </div>
    </section>

    <section class="grid lg:grid-cols-3 gap-4">
      <div class="lg:col-span-2 card">
        <div class="overflow-auto">
          <table class="w-full table">
            <thead>
              <tr>
                <th class="text-left px-3 py-2">Pedido</th>
                <th class="text-left px-3 py-2">Cliente</th>
                <th class="text-left px-3 py-2">Fecha</th>
                <th class="text-left px-3 py-2">Estado</th>
                <th class="text-left px-3 py-2">Empresa</th>
                <th class="text-left px-3 py-2">Vendedor</th>
                <th class="text-left px-3 py-2">Gestor</th>
                <th class="text-left px-3 py-2">Valor</th>
                <th class="text-left px-3 py-2">Acciones</th>
              </tr>
            </thead>
            <tbody id="tbody" class="text-sm"></tbody>
          </table>
        </div>
      </div>
      <div class="card p-3">
        <h3 class="font-semibold mb-2" style="color:var(--ink)">üìä Estad√≠sticas</h3>
        <canvas id="chartEstados" height="200"></canvas>
      </div>
    </section>

    <section class="card p-3">
      <div class="flex items-center justify-between">
        <h3 class="font-semibold" style="color:var(--ink)">üó∫Ô∏è Mapa de Pedidos</h3>
        <div class="text-xs text-gray-500" id="debugText"></div>
      </div>
      <div id="map"></div>
    </section>
  </main>

  <div id="toast" class="toast">Error</div>

<script>
// ==== CONFIG ====
const CONFIG = {
  sheets: {
    clientesCsvUrl: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQt6FhUerc3A1eDpvKdM_KJ2yU8DTXy2MpmaRMeaORqzBxFVY70XzdAw-aL9e10V8l-hsIUKUlj5Ygn/pub?gid=193390473&single=true&output=csv",
    pedidosKarakaCsvUrl: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQt6FhUerc3A1eDpvKdM_KJ2yU8DTXy2MpmaRMeaORqzBxFVY70XzdAw-aL9e10V8l-hsIUKUlj5Ygn/pub?gid=1945180719&single=true&output=csv",
    pedidosDistribuidoraCsvUrl: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQt6FhUerc3A1eDpvKdM_KJ2yU8DTXy2MpmaRMeaORqzBxFVY70XzdAw-aL9e10V8l-hsIUKUlj5Ygn/pub?gid=919779363&single=true&output=csv"
  }
};

// ==== Utils ====
function toast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),4000); }
const norm = s => (s??'').toString().normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase().trim();
function slug(s){ return norm(s).replace(/[^a-z0-9]+/g,'-'); }
function toNumber(x){ if(x==null) return null; const s=String(x).trim().replace(',','.'); const n=parseFloat(s); return Number.isFinite(n)?n:null; }
function excelDateToISO(v){ const num=Number(v); if(!Number.isFinite(num)) return String(v||''); const base=new Date(Date.UTC(1899,11,30)); const d=new Date(base.getTime()+num*86400000); return d.toISOString().slice(0,10); }
function toISO(value){ if(!value) return ''; const s=String(value); return /^\d{4}-\d{2}-\d{2}$/.test(s)?s:excelDateToISO(s); }
function parseCSV(text){
  const rows=text.trim().split(/\r?\n/); if(!rows.length) return [];
  const split=r=>r.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(c=>c.replace(/^"|"$|\r/g,''));
  const headers=split(rows.shift()); const low=headers.map(h=>norm(h));
  return rows.map(r=>{
    const c=split(r); const obj={};
    headers.forEach((h,i)=>{ obj[h]=c[i]??''; });
    obj._map={}; headers.forEach((h,i)=>obj._map[norm(h)]=c[i]??'');
    return obj;
  });
}
async function fetchCsv(url,label){ const res=await fetch(url,{cache:'no-store',mode:'cors'}); if(!res.ok) throw new Error(label+': HTTP '+res.status); return parseCSV(await res.text()); }
function getField(row, candidates){
  const m=row._map || {};
  for(const name of candidates){
    const key = norm(name);
    if(m[key]!==undefined && m[key]!=='') return m[key];
    if(row[name]!==undefined && row[name]!=='') return row[name];
    for(const k of Object.keys(row)){ if(norm(k)===key && row[k]!==''){ return row[k]; } }
  }
  return '';
}

// ==== Estado ====
let state={clientes:[], pedidos:[], map:null, markers:[], markerByKey:{}, chart:null, ui:{tab:'todos', empresa:'', q:'', desde:'', hasta:'', ven:'', ges:''}};

// ==== Column mapping ====
const COLS = {
  empresa: ['empresa','compania','compa√±ia','empresa cliente'],
  cod: ['cod empresa','cod_empresa','cod cliente','cod_cliente','codigo cliente','codigo_cliente','codigo','idcliente','id cliente','id','codigo de cliente','cod. cliente'],
  nombre: ['razon social','raz√≥n social','razonsocial','nombre','cliente','nombre cliente','nombre_cliente'],
  lat: ['latitud','lat','latitude','y'],
  lon: ['longitud','lon','lng','long','x'],
  pedidoId: ['pedido #','pedido','no pedido','n¬∞ pedido','id pedido','num pedido','nro pedido','numero de pedido'],
  fecha: ['fecha','fecha pedido','fecha_pedido'],
  estado: ['estado','estatus','situacion'],
  valor: ['valor','monto','total','importe'],
  vendedor: ['vendedor','asesor','comercial','seller'],
  gestor: ['gestor','cobrador','repartidor','mensajero','transportista','driver']
};

// canonical name (remove legal suffixes and generic words)
const LEGAL_TOKENS = new Set(['srl','srll','sa','s.a.','cxa','c.x.a.','c por a','c.por.a','cia','cia.','compania','compa√±ia','importadora','comercial','the','store','corp','company','co','sr','sa.','s.a','cxa.','cxa,']);
function canonicalName(s){
  const words = norm(s).split(/[^a-z0-9]+/).filter(Boolean);
  const filtered = words.filter(w=>!LEGAL_TOKENS.has(w));
  return filtered.join('-');
}

// ==== Build ====
function buildClients(raw){
  const byCode={}, byName={};
  const list = raw.map(c=>{
    const empresa = norm(getField(c, COLS.empresa));
    const codigo = getField(c, COLS.cod);
    const nombre = getField(c, COLS.nombre) || codigo;
    const key = (codigo? (empresa+'|'+norm(codigo)) : (empresa+'|'+slug(nombre)));
    const obj = {
      Empresa: empresa,
      _codigo: codigo,
      _nombre: nombre,
      _key: key,
      _nameKey: slug(nombre),
      _canon: canonicalName(nombre),
      _lat: toNumber(getField(c, COLS.lat)),
      _lon: toNumber(getField(c, COLS.lon))
    };
    if(codigo) byCode[empresa+'|'+norm(codigo)] = obj;
    if(obj._nameKey) byName[empresa+'|'+obj._nameKey] = obj;
    if(obj._canon) byName[empresa+'|'+obj._canon] = obj;
    return obj;
  });
  return {list, byCode, byName};
}

function buildOrders(k, d, clientIndex){
  const list = [
    ...k.map(p=>({...p, Empresa:'karaka'})),
    ...d.map(p=>({...p, Empresa:'distribuidora'})),
  ];
  // create orders and attempt to attach client key
  return list.map(p=>{
    const empresa = norm(p.Empresa);
    const codigo = getField(p, COLS.cod);
    const cliente = getField(p, COLS.nombre);
    let key = '';
    let found = null;
    if(codigo){
      key = empresa+'|'+norm(codigo);
      found = clientIndex.byCode[key];
    }
    if(!found && cliente){
      const nameKey = slug(cliente);
      found = clientIndex.byName[empresa+'|'+nameKey] || clientIndex.byName[empresa+'|'+canonicalName(cliente)];
      if(found) key = found._key;
    }
    // final fallback: keep constructed key so "Ver" puede intentar
    if(!key) key = (codigo? (empresa+'|'+norm(codigo)) : (empresa+'|'+slug(cliente)));

    return {
      Empresa: empresa,
      _key: key,
      _id: getField(p, COLS.pedidoId),
      _cliente: cliente,
      _fecha: toISO(getField(p, COLS.fecha)),
      _estado: getField(p, COLS.estado),
      _valor: getField(p, COLS.valor),
      _vendedor: getField(p, COLS.vendedor),
      _gestor: getField(p, COLS.gestor)
    };
  });
}

// ==== Load ====
async function loadData(){
  try{
    const [clientes, k, d] = await Promise.all([
      fetchCsv(CONFIG.sheets.clientesCsvUrl,'Clientes'),
      fetchCsv(CONFIG.sheets.pedidosKarakaCsvUrl,'Karaka'),
      fetchCsv(CONFIG.sheets.pedidosDistribuidoraCsvUrl,'Distribuidora')
    ]);
    const idx = buildClients(clientes);
    state.clientes = idx.list;
    state.pedidos  = buildOrders(k, d, idx);
    populatePeopleFilters();
    computeKPIs(); renderAll();
  }catch(e){ console.error(e); toast('No se pudieron cargar datos: '+e.message); populatePeopleFilters(); renderAll(); }
}

// ==== Filters for Vendedor/Gestor ====
function populatePeopleFilters(){
  const selV=document.getElementById('selVendedor');
  const selG=document.getElementById('selGestor');
  selV.innerHTML = '<option value=\"\">Todos</option>';
  selG.innerHTML = '<option value=\"\">Todos</option>';
  const vs=[...new Set(state.pedidos.map(p=>p._vendedor).filter(Boolean))].sort();
  const gs=[...new Set(state.pedidos.map(p=>p._gestor).filter(Boolean))].sort();
  for(const v of vs){ const o=document.createElement('option'); o.value=v; o.textContent=v; selV.appendChild(o); }
  for(const g of gs){ const o=document.createElement('option'); o.value=g; o.textContent=g; selG.appendChild(o); }
}

// ==== KPIs ====
function computeKPIs(){
  const today=new Date().toISOString().slice(0,10);
  const pend=state.pedidos.filter(p=>p._estado.toLowerCase().includes('pend')).length;
  const ruta=state.pedidos.filter(p=>p._estado.toLowerCase().includes('ruta')).length;
  const entr=state.pedidos.filter(p=>/final|entreg/.test(p._estado.toLowerCase())).length;
  const hoy=state.pedidos.filter(p=>p._fecha===today).length;
  document.getElementById('kpiPendientes').textContent=pend;
  document.getElementById('kpiRuta').textContent=ruta;
  document.getElementById('kpiEntregados').textContent=entr;
  document.getElementById('kpiHoy').textContent=hoy;
}

// ==== Apply filters ====
function applyFilters(rows){
  const {tab, empresa, q, desde, hasta, ven, ges} = state.ui;
  return rows.filter(p=>{
    const e=p._estado.toLowerCase();
    let okTab=true;
    if(tab==='pendientes') okTab=e.includes('pend');
    else if(tab==='facturados') okTab=e.includes('fact');
    else if(tab==='entregados') okTab=/final|entreg/.test(e);
    const okEmp=!empresa || (p.Empresa===empresa);
    const okQ=!q || (p._id?.toString().toLowerCase().includes(q) || (p._cliente||'').toLowerCase().includes(q) || e.includes(q));
    const okDesde=!desde || (p._fecha && p._fecha>=desde);
    const okHasta=!hasta || (p._fecha && p._fecha<=hasta);
    const okVen=!ven || norm(p._vendedor)===norm(ven);
    const okGes=!ges || norm(p._gestor)===norm(ges);
    return okTab && okEmp && okQ && okDesde && okHasta && okVen && okGes;
  });
}

// ==== Table ====
function renderTable(){
  const tbody=document.getElementById('tbody'); tbody.innerHTML='';
  state.ui.q=(document.getElementById('q').value||'').trim().toLowerCase();
  state.ui.desde=document.getElementById('fDesde').value||'';
  state.ui.hasta=document.getElementById('fHasta').value||'';
  state.ui.ven=document.getElementById('selVendedor').value||'';
  state.ui.ges=document.getElementById('selGestor').value||'';
  const data=applyFilters(state.pedidos);
  for(const p of data){
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td class="px-3 py-2">${p._id||''}</td>
      <td class="px-3 py-2">${p._cliente||''}</td>
      <td class="px-3 py-2">${p._fecha||''}</td>
      <td class="px-3 py-2">${p._estado||''}</td>
      <td class="px-3 py-2"><span class="badge">${p.Empresa}</span></td>
      <td class="px-3 py-2">${p._vendedor||''}</td>
      <td class="px-3 py-2">${p._gestor||''}</td>
      <td class="px-3 py-2">${p._valor||''}</td>
      <td class="px-3 py-2"><button class="btn text-sm" data-locate="${p._key}">Ver</button></td>`;
    tbody.appendChild(tr);
  }
  tbody.querySelectorAll('button[data-locate]').forEach(b=>b.addEventListener('click', e=>{
    const key=e.currentTarget.getAttribute('data-locate'); focusMarker(key);
  }));
}

// ==== Map ====
function initMap(){ state.map=L.map('map').setView([18.5,-69.9],8);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap'}).addTo(state.map);
}
function renderMap(){
  state.markers.forEach(m=>m.remove()); state.markers=[]; state.markerByKey={};
  const filtered=applyFilters(state.pedidos); const keys=new Set(filtered.map(p=>p._key));
  let ok=0,bad=0;
  for(const c of state.clientes){
    if(!keys.has(c._key)) continue;
    if(c._lat==null||c._lon==null){ bad++; continue; }
    try{
      const marker=L.marker([c._lat,c._lon]).addTo(state.map);
      marker.bindPopup(`<b>${c._nombre}</b><br/>Empresa: ${c.Empresa||''}<br/><span class='text-xs text-gray-500'>${c._key}</span>`);
      state.markers.push(marker); state.markerByKey[c._key]=marker; ok++;
    }catch(e){ bad++; }
  }
  document.getElementById('debugText').textContent=`Pines: ${ok} ‚Ä¢ Sin coordenadas: ${bad}`;
}
function focusMarker(key){ const m=state.markerByKey[key]; if(m){ state.map.setView(m.getLatLng(),14); m.openPopup(); } else toast('No hay coordenadas para este cliente.'); }

// ==== Chart ====
function renderChart(){
  const ctx=document.getElementById('chartEstados');
  const filtered=applyFilters(state.pedidos); const countBy={};
  filtered.forEach(p=>{ const e=p._estado||'N/D'; countBy[e]=(countBy[e]||0)+1; });
  const pairs=Object.entries(countBy).sort((a,b)=>b[1]-a[1]).slice(0,6);
  const labels=pairs.map(p=>p[0]); const data=pairs.map(p=>p[1]);
  if(state.chart) state.chart.destroy();
  state.chart=new Chart(ctx,{type:'bar',data:{labels,datasets:[{label:'Pedidos',data}]},options:{plugins:{legend:{display:false}}}});
}

// ==== Render all & UI ====
function renderAll(){ renderTable(); renderMap(); renderChart(); }

function bindUI(){
  document.querySelectorAll('.tab[data-tab]').forEach(el=>el.addEventListener('click',()=>{
    document.querySelectorAll('.tab[data-tab]').forEach(t=>t.classList.remove('active'));
    el.classList.add('active'); state.ui.tab=el.dataset.tab; renderAll();
  }));
  document.querySelectorAll('.chip').forEach(el=>el.addEventListener('click',()=>{
    document.querySelectorAll('.chip').forEach(t=>t.classList.remove('active'));
    el.classList.add('active'); state.ui.empresa=el.dataset.empresa||''; renderAll();
  }));
  ['q','fDesde','fHasta','selVendedor','selGestor'].forEach(id=>{
    const el=document.getElementById(id);
    el.addEventListener('input',renderAll);
    el.addEventListener('change',renderAll);
  });
  document.getElementById('refreshBtn').addEventListener('click', async ()=>{ await loadData(); toast('Datos actualizados'); });
}

// ==== Start ====
window.addEventListener('DOMContentLoaded', async ()=>{ bindUI(); initMap(); await loadData(); });
</script>
</body>
</html>
