<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Agenda de Visitas</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0b1220; --surface:#111a2c; --panel:#0f1726; --muted:#94a3b8; --text:#e5ecf6; 
  --primary:#22d3ee; --primary-600:#0891b2; --ring:#1e293b;
  --success:#10b981; --danger:#ef4444; --warning:#f59e0b;
  --border:#22304a; --chip:#1b2842;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:linear-gradient(180deg,#0a1020 0%,#0e1626 100%);color:var(--text)}
.container{max-width:1200px;margin:0 auto;padding:20px}
/* Topbar */
.topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
.h1{font-size:22px;margin:0;font-weight:700;letter-spacing:.2px}
.badge{padding:2px 8px;border-radius:999px;background:var(--chip);color:#b6c5de;border:1px solid var(--border);font-size:12px;margin-left:8px}
/* Filters */
.filters{display:grid;grid-template-columns:repeat(6,minmax(0,1fr));gap:10px;background:rgba(17,26,44,.8);border:1px solid var(--border);border-radius:14px;padding:12px;margin-bottom:14px}
label{display:block;font-size:12px;color:#b6c5de;margin-bottom:4px}
input,select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #314463;background:#0f1726;color:var(--text);outline:none}
.btn{border:1px solid #2a3d5e;background:#101a28;color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:600;font-size:13px}
.btn:hover{transform:translateY(-1px)}
.btn-primary{border:0;background:linear-gradient(135deg,#0ea5e9,#22d3ee);color:#06202b}
.btn-danger{border:0;background:linear-gradient(135deg,#c2410c,#ef4444);color:#fff}
.btn-soft{background:#0f1726;border:1px solid #2a3d5e}
/* Board */
.board{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:14px}
.col{background:rgba(17,26,44,.75);border:1px solid var(--border);border-radius:16px;padding:10px;min-height:60vh}
.col h3{margin:6px 6px 10px;font-size:15px;color:#c8d6ee;font-weight:700}
.count{font-size:12px;color:#93a2bc;margin-left:6px}
/* Card */
.card{background:#0f1726;border:1px solid #263656;border-radius:14px;padding:10px;margin:10px 6px;box-shadow:0 8px 20px rgba(0,0,0,.25)}
.card header{display:flex;justify-content:space-between;align-items:start;margin-bottom:6px}
.title{font-weight:700;letter-spacing:.2px;margin:0}
.meta{color:#9fb1cc;font-size:12px;margin-top:2px}
.controls{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-top:8px}
.note{color:#90a0b7;font-size:12px;margin-top:6px}
.tags{display:flex;gap:6px;flex-wrap:wrap;margin-top:4px}
.tag{padding:2px 8px;border-radius:999px;background:#12233e;border:1px solid #2b3f62;color:#b6c5de;font-size:11px}
.footer{display:flex;justify-content:flex-end;gap:8px;margin-top:10px}
/* Empty */
.empty{color:#8fa1bd;font-size:13px;padding:16px;text-align:center}
/* Toast */
.toast{position:fixed;left:12px;bottom:12px;background:#132036;border:1px solid #2d4266;color:#d7e7ff;padding:10px 12px;border-radius:10px;display:none;z-index:9999}
/* Responsive */
@media (max-width:980px){ .filters{grid-template-columns:repeat(2, minmax(0,1fr))} .board{grid-template-columns:1fr} }
</style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <div><h1 class="h1">Agenda de visitas</h1><span class="badge">Módulo profesional</span></div>
      <div class="tags"><span class="tag">Solo citas</span><span class="tag">Reprogramación rápida</span></div>
    </div>

    <div class="filters">
      <div><label>Desde</label><input id="fDesde" type="date"></div>
      <div><label>Hasta</label><input id="fHasta" type="date"></div>
      <div><label>Vendedor</label><select id="fVendedor"><option value="">(todos)</option></select></div>
      <div><label>Gestor</label><select id="fGestor"><option value="">(todos)</option></select></div>
      <div><label>Estatus visita</label>
        <select id="fStatus">
          <option value="">(todos)</option>
          <option>programada</option><option>asistió</option><option>no asistió</option>
          <option>reprogramada</option><option>cancelada</option>
        </select>
      </div>
      <div style="display:flex;align-items:flex-end;gap:8px;justify-content:flex-end">
        <button id="btnHoy" class="btn btn-soft">Hoy</button>
        <button id="btnSemana" class="btn btn-soft">Esta semana</button>
        <button id="btnExport" class="btn">⬇ Exportar CSV</button>
      </div>
    </div>

    <div class="board">
      <div class="col">
        <h3>Hoy <span class="count" id="cHoy">0</span></h3>
        <div id="colHoy" class="list"></div>
      </div>
      <div class="col">
        <h3>Esta semana <span class="count" id="cSemana">0</span></h3>
        <div id="colSemana" class="list"></div>
      </div>
      <div class="col">
        <h3>Futuras <span class="count" id="cFuturas">0</span></h3>
        <div id="colFuturas" class="list"></div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
// ------------------ Data access ------------------
function seedIfEmpty(){
  try{
    const raw = localStorage.getItem('llamadas_records');
    if(raw) return;
    const demo=[
      {__id:'demo-1', cliente:'INDUSTRIAS TAVERAS', cod_empresa:'distri342', vendedor:'JOSE', gestor_servicio:'JOSE', observaciones:'visitará showroom', cita_tipo:'cita_showroom', cita_fecha:formatDate(offsetDays(0)), cita_hora:'10:00', estatus_visita:'programada'},
      {__id:'demo-2', cliente:'LE PARC', cod_empresa:'karaka1172', vendedor:'EDUARD CEBALLOS', gestor_servicio:'DIOGENES', observaciones:'visitará showroom', cita_tipo:'cita_showroom', cita_fecha:formatDate(offsetDays(2)), cita_hora:'14:00', estatus_visita:'programada'},
      {__id:'demo-3', cliente:'RILON TRADING', cod_empresa:'distribu2944', vendedor:'EDUARD CEBALLOS', gestor_servicio:'EVELYN', observaciones:'seguimiento', cita_tipo:'cita_showroom', cita_fecha:formatDate(offsetDays(10)), cita_hora:'15:00', estatus_visita:'programada'}
    ];
    localStorage.setItem('llamadas_records', JSON.stringify(demo));
  }catch(e){}
}
function loadCalls(){
  let local=[]; try{ local=JSON.parse(localStorage.getItem('llamadas_records')||'[]'); }catch(e){ local=[]; }
  return local.filter(r=> r && r.cita_tipo && r.cita_tipo!=='sin_cita').map(addId);
}
function addId(r){ if(!r.__id) r.__id = (r.cod_empresa||'x') + '-' + (r.cita_fecha||Date.now()) + '-' + Math.random().toString(36).slice(2,7); return r; }
function saveCalls(records){
  localStorage.setItem('llamadas_records', JSON.stringify(records));
}
function updateCall(id, patch){
  const all = loadCalls();
  const idx = all.findIndex(x=>x.__id===id);
  if(idx>=0){ all[idx] = {...all[idx], ...patch}; saveCalls(all); }
}

// ------------------ Helpers ------------------
function el(q){ return document.querySelector(q); }
function ce(tag, cls){ const e=document.createElement(tag); if(cls) e.className=cls; return e; }
function showToast(msg){ const t=el('#toast'); t.textContent=msg; t.style.display='block'; clearTimeout(showToast._t); showToast._t=setTimeout(()=>t.style.display='none',1600); }

function offsetDays(n){ const d=new Date(); d.setDate(d.getDate()+n); d.setHours(0,0,0,0); return d; }
function startOfToday(){ const d=new Date(); d.setHours(0,0,0,0); return d; }
function endOfWeek(){ const d=startOfToday(); const day=d.getDay(); const diff=6-day; d.setDate(d.getDate()+diff); d.setHours(23,59,59,999); return d; }
function formatDate(d){ const y=d.getFullYear(); const m=('0'+(d.getMonth()+1)).slice(-2); const dd=('0'+d.getDate()).slice(-2); return y+'-'+m+'-'+dd; }

function unique(arr){ return Array.from(new Set(arr.filter(Boolean))).sort((a,b)=>String(a).localeCompare(String(b),'es')); }

// ------------------ Filters ------------------
function buildFilters(){
  const data = loadCalls();
  const vends = unique(data.map(x=>x.vendedor));
  const ges = unique(data.map(x=>x.gestor_servicio));
  const fV=el('#fVendedor'); const fG=el('#fGestor');
  fV.innerHTML = '<option value="">(todos)</option>' + vends.map(v=>`<option>${v}</option>`).join('');
  fG.innerHTML = '<option value="">(todos)</option>' + ges.map(v=>`<option>${v}</option>`).join('');
}
function getFilter(){
  return { 
    desde: el('#fDesde').value, hasta: el('#fHasta').value, 
    vendedor: el('#fVendedor').value, gestor: el('#fGestor').value, status: el('#fStatus').value
  };
}

// ------------------ Render ------------------
function render(){
  const hoyWrap = el('#colHoy'), semWrap = el('#colSemana'), futWrap = el('#colFuturas');
  hoyWrap.innerHTML = semWrap.innerHTML = futWrap.innerHTML = '';
  const cHoy=el('#cHoy'), cSem=el('#cSemana'), cFut=el('#cFuturas');

  const ds = el('#fDesde').value? new Date(el('#fDesde').value+'T00:00:00') : null;
  const hs = el('#fHasta').value? new Date(el('#fHasta').value+'T23:59:59') : null;
  const { vendedor, gestor, status } = getFilter();

  const today = startOfToday();
  const weekEnd = endOfWeek();

  const items = loadCalls().filter(r=>{
    const f = r.cita_fecha ? new Date(r.cita_fecha+'T'+(r.cita_hora||'00:00')) : null;
    if(ds && f && f<ds) return false;
    if(hs && f && f>hs) return false;
    if(vendedor && r.vendedor!==vendedor) return false;
    if(gestor && r.gestor_servicio!==gestor) return false;
    if(status && (r.estatus_visita||'programada')!==status) return false;
    return true;
  }).sort((a,b)=> String(a.cita_fecha).localeCompare(String(b.cita_fecha)));

  let c1=0,c2=0,c3=0;
  items.forEach(r=>{
    const f = r.cita_fecha ? new Date(r.cita_fecha+'T'+(r.cita_hora||'00:00')) : null;
    const card = renderCard(r);
    if(!f || f.toDateString()===today.toDateString()){ hoyWrap.appendChild(card); c1++; }
    else if(f<=weekEnd){ semWrap.appendChild(card); c2++; }
    else { futWrap.appendChild(card); c3++; }
  });
  cHoy.textContent=c1; cSem.textContent=c2; cFut.textContent=c3;

  if(!c1) hoyWrap.innerHTML = '<div class="empty">Sin visitas para hoy</div>';
  if(!c2) semWrap.innerHTML = '<div class="empty">No hay visitas dentro de la semana</div>';
  if(!c3) futWrap.innerHTML = '<div class="empty">No hay visitas futuras</div>';
}

function renderCard(r){
  const card = ce('div','card');
  const header = ce('header');
  const hTitle = ce('div');
  hTitle.innerHTML = `<div class="title">${escapeHtml(r.cliente||'')}</div>
  <div class="meta">${escapeHtml(r.cod_empresa||'')} • ${escapeHtml(r.vendedor||'')} • ${escapeHtml(r.gestor_servicio||'')}</div>`;
  header.appendChild(hTitle);
  card.appendChild(header);

  // Controls
  const ctrls = ce('div','controls');
  const inFecha = ce('input'); inFecha.type='date'; inFecha.value=r.cita_fecha||'';
  const inHora  = ce('input'); inHora.type='time'; inHora.value=r.cita_hora||'';
  const selEst  = ce('select');
  ;['programada','asistió','no asistió','reprogramada','cancelada'].forEach(s=>{
    const o=ce('option'); o.value=s; o.textContent=s; if((r.estatus_visita||'programada')===s) o.selected=true; selEst.appendChild(o);
  });
  ctrls.append(inFecha,inHora,selEst);
  card.appendChild(ctrls);

  // Note
  if(r.observaciones){ const note=ce('div','note'); note.textContent=r.observaciones; card.appendChild(note); }

  // Footer
  const ft=ce('div','footer');
  const b1=ce('button','btn btn-soft'); b1.textContent='+1 día';
  const b2=ce('button','btn btn-soft'); b2.textContent='+1 semana';
  const bSave=ce('button','btn btn-primary'); bSave.textContent='Guardar';
  ft.append(b1,b2,bSave); card.appendChild(ft);

  b1.addEventListener('click', ()=>{
    const d = new Date((inFecha.value || formatDate(startOfToday()))+'T'+(inHora.value||'00:00'));
    d.setDate(d.getDate()+1); inFecha.value = formatDate(d);
  });
  b2.addEventListener('click', ()=>{
    const d = new Date((inFecha.value || formatDate(startOfToday()))+'T'+(inHora.value||'00:00'));
    d.setDate(d.getDate()+7); inFecha.value = formatDate(d);
  });
  bSave.addEventListener('click', ()=>{
    updateCall(r.__id, { cita_fecha:inFecha.value, cita_hora:inHora.value, estatus_visita:selEst.value });
    showToast('Cita actualizada');
    render();
  });

  return card;
}

function escapeHtml(s){ return String(s).replace(/[&<>"']/g,m=>({&:'&amp;', '<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;'}[m])); }

// ------------------ Export ------------------
function exportCSV(){
  const ds = el('#fDesde').value? new Date(el('#fDesde').value+'T00:00:00') : null;
  const hs = el('#fHasta').value? new Date(el('#fHasta').value+'T23:59:59') : null;
  const { vendedor, gestor, status } = getFilter();
  const data = loadCalls().filter(r=>{
    const f = r.cita_fecha ? new Date(r.cita_fecha+'T'+(r.cita_hora||'00:00')) : null;
    if(ds && f && f<ds) return false;
    if(hs && f && f>hs) return false;
    if(vendedor && r.vendedor!==vendedor) return false;
    if(gestor && r.gestor_servicio!==gestor) return false;
    if(status && (r.estatus_visita||'programada')!==status) return false;
    return true;
  });
  const headers=['Cliente','Código','Vendedor','Gestor','Fecha','Hora','Estatus','Tipo','Observaciones'];
  const rows=data.map(r=>[r.cliente||'',r.cod_empresa||'',r.vendedor||'',r.gestor_servicio||'',r.cita_fecha||'',r.cita_hora||'',r.estatus_visita||'programada',r.cita_tipo||'',r.observaciones||'']);
  const csv=[headers.join(','),...rows.map(r=>r.map(csvEsc).join(','))].join('\n');
  const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.download='agenda_visitas.csv'; a.click(); URL.revokeObjectURL(a.href);
}
function csvEsc(v){ const s=String(v); return (s.includes(',')||s.includes('"')||s.includes('\n'))?('"'+s.replace(/"/g,'""')+'"'):s; }

// ------------------ Init ------------------
function quickRange(type){
  const today = startOfToday();
  if(type==='hoy'){
    el('#fDesde').value = formatDate(today);
    el('#fHasta').value = formatDate(today);
  }else{
    el('#fDesde').value = formatDate(today);
    el('#fHasta').value = formatDate(endOfWeek());
  }
  render();
}
document.addEventListener('DOMContentLoaded', ()=>{
  seedIfEmpty();
  buildFilters();
  render();
  el('#fDesde').addEventListener('change', render);
  el('#fHasta').addEventListener('change', render);
  el('#fVendedor').addEventListener('change', render);
  el('#fGestor').addEventListener('change', render);
  el('#fStatus').addEventListener('change', render);
  el('#btnExport').addEventListener('click', exportCSV);
  el('#btnHoy').addEventListener('click', ()=>quickRange('hoy'));
  el('#btnSemana').addEventListener('click', ()=>quickRange('semana'));
});
</script>
</body>
</html>
