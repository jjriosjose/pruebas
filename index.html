
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Log√≠stica & Almac√©n ‚Äî Pedidos (Cod Empresa)</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{ --ink:#0b3a55; --brand:#0ea5e9; --brand2:#2563eb; }
    body{background:#f5f7fb;color:#0f172a}
    .navbar{background:#0f172a;color:#e5eef9; position:sticky; top:0; z-index:50}
    .kpi{background:#fff;border:1px solid #e5e7eb;border-radius:0.8rem;padding:.9rem 1rem}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:0.8rem}
    .btn{background:var(--brand);color:#fff;border-radius:.55rem;padding:.5rem .9rem}
    .btn:hover{filter:brightness(.97)}
    .tab{border:1px solid #e5e7eb;border-radius:.6rem;padding:.45rem .8rem;background:#fff;cursor:pointer; white-space:nowrap}
    .tab.active{background:#0ea5e9;color:#fff;border-color:#0ea5e9}
    .chip{border:1px solid #e5e7eb;border-radius:9999px;padding:.25rem .6rem;background:#fff;cursor:pointer; white-space:nowrap}
    .chip.active{background:#2563eb;color:#fff;border-color:#2563eb}
    .badge{background:#eef6ff;border:1px solid #dbeafe;color:#0b3a55;border-radius:9999px;padding:2px 10px;font-size:12px}
    #map{height:50vh;border-radius:.8rem;border:1px solid #e5e7eb}
    @media (min-width: 768px){ #map{height:60vh;} }
    .toast{position:fixed;right:1rem;bottom:1rem;background:#fee2e2;color:#7f1d1d;border:1px solid #fecaca;border-radius:.6rem;padding:.6rem .8rem;display:none;z-index:9999}
    .toast.show{display:block}
    .table th{font-size:.8rem;text-transform:uppercase;color:#334155;background:#f3f4f6}
    .table td{border-top:1px solid #f1f5f9}
    .link{color:#2563eb;cursor:pointer;text-decoration:underline}
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="max-w-7xl mx-auto flex items-center justify-between p-3">
      <div class="flex items-center gap-3">
        <img src="./logo.png" alt="Logo" class="h-8 w-8 object-contain rounded">
        <div class="text-lg font-semibold">Log√≠stica & Almac√©n</div>
      </div>
      <div class="flex items-center gap-4 text-xs sm:text-sm">
        <span id="lastUpdate" class="opacity-80 hidden sm:block"></span>
        <button id="refreshBtn" class="btn">Actualizar</button>
      </div>
    </div>
  </nav>

  <header class="bg-white border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4 py-4 sm:py-5">
      <h1 class="text-xl sm:text-2xl font-bold" style="color:var(--ink)">Sistema de Gesti√≥n de Pedidos</h1>
      <p class="text-xs sm:text-sm text-gray-500">Asociaci√≥n por <b>Cod Empresa</b> (clientes ‚Üî pedidos)</p>
    </div>
  </header>

  <main class="max-w-7xl mx-auto p-3 sm:p-4 space-y-4">
    <!-- KPIs -->
    <section class="grid grid-cols-2 md:grid-cols-4 gap-3">
      <div class="kpi">
        <div class="text-xs sm:text-sm">Pendientes</div>
        <div class="text-xl sm:text-2xl font-semibold" id="kpiPendientes">‚Äî</div>
      </div>
      <div class="kpi">
        <div class="text-xs sm:text-sm">Hoy</div>
        <div class="text-xl sm:text-2xl font-semibold" id="kpiHoy">‚Äî</div>
      </div>
      <div class="kpi">
        <div class="text-xs sm:text-sm">En ruta</div>
        <div class="text-xl sm:text-2xl font-semibold" id="kpiRuta">‚Äî</div>
      </div>
      <div class="kpi">
        <div class="text-xs sm:text-sm">Entregados 7d</div>
        <div class="text-xl sm:text-2xl font-semibold" id="kpiEntregados">‚Äî</div>
      </div>
    </section>

    <!-- Filtros -->
    <section class="card p-3">
      <div class="flex flex-wrap gap-2 items-center">
        <div class="tab active" data-tab="todos">Todos</div>
        <div class="tab" data-tab="pendientes">Pendientes</div>
        <div class="tab" data-tab="facturados">Facturados</div>
        <div class="tab" data-tab="entregados">Entregados</div>

        <div class="w-full md:w-auto"></div>

        <div class="flex items-center gap-2 text-xs sm:text-sm">
          <span>Empresa:</span>
          <span class="chip active" data-empresa="">Todas</span>
          <span class="chip" data-empresa="karaka">karaka</span>
          <span class="chip" data-empresa="distribuidora">distribuidora</span>
        </div>

        <div class="flex items-center gap-2 text-xs sm:text-sm">
          <label for="selVendedor" class="text-gray-600">Vendedor:</label>
          <select id="selVendedor" class="border border-gray-300 rounded-md px-2 sm:px-3 py-1 bg-white">
            <option value="">Todos</option>
          </select>
          <label for="selGestor" class="text-gray-600 ml-1 sm:ml-2">Gestor:</label>
          <select id="selGestor" class="border border-gray-300 rounded-md px-2 sm:px-3 py-1 bg-white">
            <option value="">Todos</option>
          </select>
        </div>

        <div class="flex items-center gap-2 ml-auto">
          <input id="q" type="search" placeholder="Buscar pedido/cliente/estado" class="border border-gray-300 rounded-md px-2 sm:px-3 py-1 w-44 sm:w-64 bg-white">
          <input id="fDesde" type="date" class="border border-gray-300 rounded-md px-2 sm:px-3 py-1 bg-white">
          <input id="fHasta" type="date" class="border border-gray-300 rounded-md px-2 sm:px-3 py-1 bg-white">
        </div>
      </div>
    </section>

    <!-- Mapa (arriba) -->
    <section class="card p-3">
      <div class="flex items-center justify-between">
        <h3 class="font-semibold text-sm sm:text-base" style="color:var(--ink)">üó∫Ô∏è Mapa de Pedidos</h3>
        <div class="flex items-center gap-4">
          <div class="text-[11px] sm:text-xs text-gray-500" id="debugText"></div>
          <button id="toggleMap" class="link text-xs sm:text-sm">Ocultar mapa</button>
        </div>
      </div>
      <div id="mapWrap"><div id="map"></div></div>
    </section>

    <!-- Tabla + Estad√≠sticas -->
    <section class="grid lg:grid-cols-3 gap-4">
      <div class="lg:col-span-2 card">
        <div class="flex items-center justify-between p-3">
          <h3 class="font-semibold text-sm sm:text-base" style="color:var(--ink)">üìã Pedidos</h3>
          <button id="toggleTable" class="link text-xs sm:text-sm">Ocultar tabla</button>
        </div>
        <div id="tableWrap" class="overflow-auto">
          <table class="w-full table min-w-[860px]">
            <thead>
              <tr>
                <th class="text-left px-2 sm:px-3 py-2">Pedido</th>
                <th class="text-left px-2 sm:px-3 py-2">Cliente</th>
                <th class="text-left px-2 sm:px-3 py-2">Cod Empresa</th>
                <th class="text-left px-2 sm:px-3 py-2">Fecha</th>
                <th class="text-left px-2 sm:px-3 py-2">Estado</th>
                <th class="text-left px-2 sm:px-3 py-2">Empresa</th>
                <th class="text-left px-2 sm:px-3 py-2">Vendedor</th>
                <th class="text-left px-2 sm:px-3 py-2">Gestor</th>
                <th class="text-left px-2 sm:px-3 py-2">Valor</th>
                <th class="text-left px-2 sm:px-3 py-2">Acciones</th>
              </tr>
            </thead>
            <tbody id="tbody" class="text-xs sm:text-sm"></tbody>
          </table>
        </div>
      </div>
      <div class="card p-3">
        <h3 class="font-semibold mb-2 text-sm sm:text-base" style="color:var(--ink)">üìä Estad√≠sticas</h3>
        <canvas id="chartEstados" height="220"></canvas>
      </div>
    </section>
  </main>

  <div id="toast" class="toast">Error</div>

<script>
// ======= CONFIG (CSV publicados) =======
const CONFIG = {
  sheets: {
    clientesCsvUrl: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQt6FhUerc3A1eDpvKdM_KJ2yU8DTXy2MpmaRMeaORqzBxFVY70XzdAw-aL9e10V8l-hsIUKUlj5Ygn/pub?gid=193390473&single=true&output=csv",
    pedidosKarakaCsvUrl: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQt6FhUerc3A1eDpvKdM_KJ2yU8DTXy2MpmaRMeaORqzBxFVY70XzdAw-aL9e10V8l-hsIUKUlj5Ygn/pub?gid=1945180719&single=true&output=csv",
    pedidosDistribuidoraCsvUrl: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQt6FhUerc3A1eDpvKdM_KJ2yU8DTXy2MpmaRMeaORqzBxFVY70XzdAw-aL9e10V8l-hsIUKUlj5Ygn/pub?gid=919779363&single=true&output=csv"
  }
};

// ======= Utilidades =======
function toast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),4000); }
const norm = s => (s??'').toString().normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase().trim();

// N√∫mero flexible para lat/lon: maneja "18,442.233", "18.442,233", "18,442", "18.442"
function smartFloat(x){
  if(x==null) return null;
  let s=String(x).trim();
  if(s==='') return null;
  // elimina espacios
  s = s.replace(/\s+/g,'');
  // si es puro n√∫mero con signo y punto/decimal: prueba directo
  const direct = Number(s.replace(',', '.'));
  if(Number.isFinite(direct) && /[\d\.\-]/.test(s)) return direct;
  // detectar √∫ltimo separador
  const lastComma = s.lastIndexOf(',');
  const lastDot   = s.lastIndexOf('.');
  if(lastComma>lastDot){ // coma como decimal
    s = s.replace(/\./g,''); // quitar miles
    s = s.replace(',', '.'); // decimal
  }else if(lastDot>lastComma){ // punto como decimal
    s = s.replace(/,/g,''); // quitar miles
  }else{
    // sin separadores claros, quitar todo menos d√≠gitos, punto y signo
    s = s.replace(/[^0-9\.\-]/g,'');
  }
  const n = parseFloat(s);
  return Number.isFinite(n) ? n : null;
}

// Excel serial
function excelDateToISO(num){ const base=new Date(Date.UTC(1899,11,30)); const d=new Date(base.getTime()+num*86400000); return d.toISOString().slice(0,10); }
// dd/mm/yyyy
function dmyToISO(s){ const m=s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/); if(!m) return ''; const [_,d,mo,y]=m; const dd=d.padStart(2,'0'); const mm=mo.padStart(2,'0'); return `${y}-${mm}-${dd}`; }
// mm/dd/yyyy
function mdyToISO(s){ const m=s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/); if(!m) return ''; const [_,mo,d,y]=m; const dd=d.padStart(2,'0'); const mm=mo.padStart(2,'0'); return `${y}-${mm}-${dd}`; }
function detectAndISO(s){
  const parts = s.split(/[\/\-]/);
  if(parts.length===3){
    const [a,b,c]=parts.map(x=>parseInt(x,10));
    if(!isNaN(a)&&!isNaN(b)&&!isNaN(c)){
      if(a>12) return dmyToISO(s); // 31/01/2025 -> DMY
      if(b>12) return mdyToISO(s); // 01/31/2025 -> MDY
      return dmyToISO(s); // por defecto DMY
    }
  }
  return '';
}
function toISO(value){
  if(value===null||value===undefined) return '';
  const s=String(value).trim();
  if(s==='') return '';
  if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
  if(/^\d{1,2}[\/\-]\d{1,2}[\/\-]\d{4}$/.test(s)) return detectAndISO(s);
  const num=Number(s); if(Number.isFinite(num)) return excelDateToISO(num);
  const d=new Date(s); if(!isNaN(d)) return d.toISOString().slice(0,10);
  return '';
}
function parseCSV(text){
  const rows=text.trim().split(/\r?\n/); if(!rows.length) return [];
  const split=r=>r.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(c=>c.replace(/^"|"$|\r/g,''));
  const headers=split(rows.shift());
  return rows.map(r=>{ const c=split(r); const o={}; headers.forEach((h,i)=>o[h]=c[i]??''); return o; });
}
async function fetchCsv(url,label){ const res=await fetch(url,{cache:'no-store'}); if(!res.ok) throw new Error(label+': HTTP '+res.status); return parseCSV(await res.text()); }

// ======= Columnas =======
const COLS = {
  codEmpresa: ['Cod Empresa','COD EMPRESA','Cod_Empresa','CodEmpresa','cod empresa','cod_empresa','codempresa','codigo empresa','codigo_empresa'],
  empresaHoja: ['Empresa','empresa'], // solo en Clientes si existiera
  nombreCliente: ['Razon Social','Raz√≥n Social','RAZON SOCIAL','Cliente','NOMBRE','Nombre','Nombre Cliente','Nombre cliente','cliente','CLIENTE'],
  lat: ['latitud','Latitud','LATITUD','lat','Lat','LAT'],
  lon: ['longitud','Longitud','LONGITUD','lon','Lon','LON','lng','Lng','LNG'],
  pedidoId: ['PEDIDO #','Pedido','PEDIDO','Pedido #','No Pedido','N¬∫ Pedido','N¬∞ Pedido'],
  fecha: ['FECHA','Fecha','fecha','Fecha Pedido','FECHA PEDIDO'],
  estado: ['ESTADO','Estado','estado','Estatus','ESTATUS'],
  valor: ['VALOR','Valor','Total','Monto'],
  vendedor: ['Vendedor','VENDEDOR','Asesor','Comercial'],
  gestor: ['Gestor','GESTOR','Repartidor','Transportista','Driver']
};

function getFirst(row, keys){
  for(const k of keys){ if(row[k]!==undefined && String(row[k]).trim()!=='' ) return String(row[k]).trim(); }
  for(const k of Object.keys(row)){
    for(const target of keys){
      if(norm(k)===norm(target) && String(row[k]).trim()!=='') return String(row[k]).trim();
    }
  }
  return '';
}

// ======= Estado =======
let state={clientes:[], pedidos:[], map:null, markers:[], markerByCode:{}, chart:null, ui:{tab:'todos', empresa:'', q:'', desde:'', hasta:'', ven:'', ges:''}};

// ======= Carga =======
async function loadData(){
  try{
    const [rawClientes, rawK, rawD] = await Promise.all([
      fetchCsv(CONFIG.sheets.clientesCsvUrl,'Clientes'),
      fetchCsv(CONFIG.sheets.pedidosKarakaCsvUrl,'Karaka'),
      fetchCsv(CONFIG.sheets.pedidosDistribuidoraCsvUrl,'Distribuidora')
    ]);

    // Clientes indexados por Cod Empresa, posible vendedor/gestor
    const clients = rawClientes.map(c=>{
      const cod = String(getFirst(c, COLS.codEmpresa)||'').trim();
      return {
        codEmpresa: cod,
        empresa: (getFirst(c, COLS.empresaHoja)||'').toString().toLowerCase(),
        nombre: getFirst(c, COLS.nombreCliente) || cod,
        lat: smartFloat(getFirst(c, COLS.lat)),
        lon: smartFloat(getFirst(c, COLS.lon)),
        vendedor: getFirst(c, COLS.vendedor) || '',
        gestor: getFirst(c, COLS.gestor) || '',
      };
    }).filter(c=>c.codEmpresa!==''); // solo con c√≥digo

    const byCode = {}; clients.forEach(c=>byCode[c.codEmpresa]=c);
    state.clientes = clients;

    // Pedidos enlazados por Cod Empresa (heredan vendedor/gestor del cliente si falta)
    const orders = [
      ...rawK.map(p=>({ ...p, EmpresaHoja:'karaka' })),
      ...rawD.map(p=>({ ...p, EmpresaHoja:'distribuidora' }))
    ].map(p=>{
      const cod = String(getFirst(p, COLS.codEmpresa)||'').trim();
      const cli = byCode[cod] || null;
      const vendedor = getFirst(p, COLS.vendedor) || (cli ? cli.vendedor : '');
      const gestor   = getFirst(p, COLS.gestor)   || (cli ? cli.gestor   : '');
      return {
        id: getFirst(p, COLS.pedidoId),
        cliente: getFirst(p, COLS.nombreCliente) || (cli ? cli.nombre : ''),
        codEmpresa: cod,
        fecha: toISO(getFirst(p, COLS.fecha)),
        estado: getFirst(p, COLS.estado),
        valor: getFirst(p, COLS.valor),
        vendedor, gestor,
        empresa: (p.EmpresaHoja||'').toString().toLowerCase(),
        clienteRef: cli
      };
    });

    state.pedidos = orders;

    populatePeopleFilters();
    computeKPIs();
    renderAll();

    const dt = new Date();
    document.getElementById('lastUpdate').textContent = `Actualizado: ${dt.toLocaleDateString()} ${dt.toLocaleTimeString()}`;
  }catch(e){
    console.error(e); toast('No se pudieron cargar datos: '+e.message);
  }
}

// ======= KPIs =======
function computeKPIs(){
  const today=new Date().toISOString().slice(0,10);
  const pend=state.pedidos.filter(p=>(p.estado||'').toLowerCase().includes('pend')).length;
  const ruta=state.pedidos.filter(p=>(p.estado||'').toLowerCase().includes('ruta')).length;
  const entr=state.pedidos.filter(p=>/final|entreg/.test((p.estado||'').toLowerCase())).length;
  const hoy=state.pedidos.filter(p=>p.fecha===today).length;
  document.getElementById('kpiPendientes').textContent=pend;
  document.getElementById('kpiRuta').textContent=ruta;
  document.getElementById('kpiEntregados').textContent=entr;
  document.getElementById('kpiHoy').textContent=hoy;
}

// ======= Filtros =======
function uniqueNormalized(values){
  const map=new Map();
  for(const v of values){
    const t=String(v||'').trim();
    if(!t) continue;
    const key=norm(t);
    if(!map.has(key)) map.set(key, t);
  }
  return [...map.values()].sort((a,b)=>a.localeCompare(b));
}
function populatePeopleFilters(){
  const selV=document.getElementById('selVendedor');
  const selG=document.getElementById('selGestor');
  selV.innerHTML='<option value="">Todos</option>';
  selG.innerHTML='<option value="">Todos</option>';
  const vs=uniqueNormalized([
    ...state.pedidos.map(p=>p.vendedor),
    ...state.clientes.map(c=>c.vendedor)
  ]);
  const gs=uniqueNormalized([
    ...state.pedidos.map(p=>p.gestor),
    ...state.clientes.map(c=>c.gestor)
  ]);
  vs.forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; selV.appendChild(o); });
  gs.forEach(g=>{ const o=document.createElement('option'); o.value=g; o.textContent=g; selG.appendChild(o); });
}

function applyFilters(rows){
  const ui = state.ui;
  return rows.filter(p=>{
    const e=(p.estado||'').toLowerCase();
    let okTab=true;
    if(ui.tab==='pendientes') okTab=e.includes('pend');
    else if(ui.tab==='facturados') okTab=e.includes('fact');
    else if(ui.tab==='entregados') okTab=/final|entreg/.test(e);
    const okEmp = !ui.empresa || p.empresa===ui.empresa;
    const q = (ui.q||'').toLowerCase();
    const okQ = !q || (String(p.id||'').toLowerCase().includes(q) ||
                       (p.cliente||'').toLowerCase().includes(q) ||
                       e.includes(q) ||
                       (p.codEmpresa||'').toLowerCase().includes(q));
    const okDesde = !ui.desde || (p.fecha && p.fecha>=ui.desde);
    const okHasta = !ui.hasta || (p.fecha && p.fecha<=ui.hasta);
    const okVen = !ui.ven || String(p.vendedor||'')===ui.ven;
    const okGes = !ui.ges || String(p.gestor||'')===ui.ges;
    return okTab && okEmp && okQ && okDesde && okHasta && okVen && okGes;
  });
}

// ======= Tabla =======
function renderTable(){
  const tbody=document.getElementById('tbody'); tbody.innerHTML='';
  state.ui.q=(document.getElementById('q').value||'').trim();
  state.ui.desde=document.getElementById('fDesde').value||'';
  state.ui.hasta=document.getElementById('fHasta').value||'';
  state.ui.ven=document.getElementById('selVendedor').value||'';
  state.ui.ges=document.getElementById('selGestor').value||'';
  const data=applyFilters(state.pedidos);

  for(const p of data){
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td class="px-2 sm:px-3 py-2">${p.id||''}</td>
      <td class="px-2 sm:px-3 py-2">${p.cliente||''}</td>
      <td class="px-2 sm:px-3 py-2">${p.codEmpresa||''}</td>
      <td class="px-2 sm:px-3 py-2">${p.fecha||''}</td>
      <td class="px-2 sm:px-3 py-2">${p.estado||''}</td>
      <td class="px-2 sm:px-3 py-2"><span class="badge">${p.empresa||''}</span></td>
      <td class="px-2 sm:px-3 py-2">${p.vendedor||''}</td>
      <td class="px-2 sm:px-3 py-2">${p.gestor||''}</td>
      <td class="px-2 sm:px-3 py-2">${p.valor||''}</td>
      <td class="px-2 sm:px-3 py-2">
        <button class="btn text-xs sm:text-sm" data-cod="${p.codEmpresa||''}">Ver</button>
      </td>`;
    tbody.appendChild(tr);
  }
  // botones Ver
  tbody.querySelectorAll('button[data-cod]').forEach(b=>b.addEventListener('click', e=>{
    const cod=e.currentTarget.getAttribute('data-cod'); focusMarker(cod);
  }));
}

// ======= Mapa =======
function initMap(){ state.map=L.map('map').setView([18.5,-69.9],8);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap'}).addTo(state.map);
}
function renderMap(){
  state.markers.forEach(m=>m.remove()); state.markers=[]; state.markerByCode={};
  const filtered=applyFilters(state.pedidos);
  const used = new Set(filtered.map(p=>p.codEmpresa).filter(Boolean));

  let ok=0, noGeo=0, noClient=0;
  for(const cod of used){
    const c = state.clientes.find(x=>x.codEmpresa===cod);
    if(!c){ noClient++; continue; }
    if(c.lat==null || c.lon==null){ noGeo++; continue; }
    const m=L.marker([c.lat,c.lon]).addTo(state.map);
    m.bindPopup(`<b>${c.nombre||cod}</b><br/>Cod Empresa: ${c.codEmpresa}${c.vendedor?'<br/>Vendedor: '+c.vendedor:''}${c.gestor?'<br/>Gestor: '+c.gestor:''}`);
    state.markers.push(m); state.markerByCode[c.codEmpresa]=m; ok++;
  }
  document.getElementById('debugText').textContent=`Pines: ${ok} ‚Ä¢ Sin coordenadas: ${noGeo} ‚Ä¢ Sin cliente: ${noClient}`;
}
function focusMarker(cod){ const m=state.markerByCode[cod]; if(m){ state.map.setView(m.getLatLng(),14); m.openPopup(); } else toast('No hay coordenadas o cliente para este c√≥digo.'); }

// ======= Chart =======
function renderChart(){
  const ctx=document.getElementById('chartEstados');
  const filtered=applyFilters(state.pedidos); const countBy={};
  filtered.forEach(p=>{ const e=p.estado||'N/D'; countBy[e]=(countBy[e]||0)+1; });
  const pairs=Object.entries(countBy).sort((a,b)=>b[1]-a[1]).slice(0,6);
  const labels=pairs.map(p=>p[0]); const data=pairs.map(p=>p[1]);
  if(state.chart) state.chart.destroy();
  state.chart=new Chart(ctx,{type:'bar',data:{labels,datasets:[{label:'Pedidos',data}]},options:{plugins:{legend:{display:false}}}});
}

// ======= Render + Eventos =======
function renderAll(){ renderTable(); renderMap(); renderChart(); }

function bindUI(){
  // tabs estado
  document.querySelectorAll('.tab[data-tab]').forEach(el=>el.addEventListener('click',()=>{
    document.querySelectorAll('.tab[data-tab]').forEach(t=>t.classList.remove('active'));
    el.classList.add('active'); state.ui.tab=el.dataset.tab; renderAll();
  }));
  // chips empresa
  document.querySelectorAll('.chip').forEach(el=>el.addEventListener('click',()=>{
    document.querySelectorAll('.chip').forEach(t=>t.classList.remove('active'));
    el.classList.add('active'); state.ui.empresa=el.dataset.empresa||''; renderAll();
  }));
  // inputs
  ['q','fDesde','fHasta','selVendedor','selGestor'].forEach(id=>{
    const el=document.getElementById(id);
    el.addEventListener('input',renderAll);
    el.addEventListener('change',renderAll);
  });
  // toggle tabla
  const toggleT = document.getElementById('toggleTable');
  const wrapT   = document.getElementById('tableWrap');
  toggleT.addEventListener('click',()=>{
    if(wrapT.style.display==='none'){ wrapT.style.display='block'; toggleT.textContent='Ocultar tabla'; }
    else { wrapT.style.display='none'; toggleT.textContent='Mostrar tabla'; }
  });
  // toggle mapa
  const toggleM = document.getElementById('toggleMap');
  const wrapM   = document.getElementById('mapWrap');
  toggleM.addEventListener('click',()=>{
    if(wrapM.style.display==='none'){ wrapM.style.display='block'; toggleM.textContent='Ocultar mapa'; setTimeout(()=>{ state.map.invalidateSize(); }, 250); }
    else { wrapM.style.display='none'; toggleM.textContent='Mostrar mapa'; }
  });
  // refresh
  document.getElementById('refreshBtn').addEventListener('click', async ()=>{ await loadData(); toast('Datos actualizados'); });
}

// ======= Start =======
window.addEventListener('DOMContentLoaded', async ()=>{ bindUI(); initMap(); await loadData(); });
</script>
</body>
</html>
