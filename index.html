<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Agenda de Visitas</title>
<style>
:root{
  --bg:#0b1220; --card:#131c2b; --muted:#90a0b7; --text:#e8eef9;
  --chip:#1f2a40; --primary:#2dd4bf; --danger:#ef4444; --border:#22304a;
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;color:var(--text);background:linear-gradient(180deg,#0b1220 0%,#0e1626 100%);}
.container{max-width:1200px;margin:0 auto;padding:16px;}
h1{margin:8px 0 12px;}
.card{background:rgba(19,28,43,0.92);border:1px solid var(--border);border-radius:16px;padding:12px;box-shadow:0 10px 30px rgba(0,0,0,.25);}
.toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:end;margin-bottom:8px}
.grid{display:grid;gap:8px}
.grid-3{grid-template-columns:repeat(3,minmax(0,1fr))}
.select,input,select,button{border-radius:10px;border:1px solid #314463;background:#0f1726;color:var(--text);padding:10px;outline:none}
.btn{cursor:pointer;font-weight:600;border-radius:12px;border:1px solid #28405f;background:#0f1726;color:var(--text);padding:8px 10px}
.btn-primary{background:linear-gradient(135deg,#1aa27f,#2dd4bf);border:0;color:#062017}
.btn-soft{background:#101a2e;border:1px solid #2c3d5d}
.columns{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
.column .title{margin:0 0 6px;font-size:16px}
.column{display:flex;flex-direction:column;gap:8px}
.card.visit{padding:10px}
.muted{color:var(--muted);font-size:12px}
.badge{padding:2px 8px;border-radius:999px;background:var(--chip);color:#a7b3c8;border:1px solid #2a3a59;font-size:11px}
.inline{display:flex;gap:8px;align-items:center}
.sep{height:1px;background:var(--border);margin:8px 0}
.errbar{position:fixed;left:8px;right:8px;bottom:8px;background:#2a1220;border:1px solid #6b273d;color:#ffd0df;padding:8px 10px;border-radius:12px;display:none}
</style>
</head>
<body>
<div class="container">
  <div class="inline" style="justify-content:space-between">
    <h1>üóìÔ∏è Agenda de Visitas</h1>
    <div class="inline">
      <span class="badge" id="statCount">0 visitas</span>
      <button class="btn" id="btnExport">‚¨á Exportar CSV</button>
    </div>
  </div>

  <div class="card">
    <div class="grid grid-3">
      <div><label>Desde</label><input id="fDesde" type="date"></div>
      <div><label>Hasta</label><input id="fHasta" type="date"></div>
      <div><label>Estatus visita</label>
        <select id="fStatus">
          <option value="">(todos)</option>
          <option value="programada">programada</option>
          <option value="asisti√≥">asisti√≥</option>
          <option value="no asisti√≥">no asisti√≥</option>
          <option value="reprogramada">reprogramada</option>
          <option value="cancelada">cancelada</option>
        </select>
      </div>
      <div><label>Vendedor</label><select id="fVendedor"><option value="">(todos)</option></select></div>
      <div><label>Gestor</label><select id="fGestor"><option value="">(todos)</option></select></div>
      <div style="display:flex;align-items:end;gap:8px"><button id="btnClear" class="btn-soft btn">Limpiar filtros</button></div>
    </div>
  </div>

  <div class="columns" style="margin-top:10px">
    <div class="column">
      <div class="card"><h3 class="title">Hoy</h3><div id="colHoy"></div></div>
    </div>
    <div class="column">
      <div class="card"><h3 class="title">Esta semana</h3><div id="colSemana"></div></div>
    </div>
    <div class="column">
      <div class="card"><h3 class="title">Futuras</h3><div id="colFuturas"></div></div>
    </div>
  </div>
</div>

<div class="errbar" id="errbar"></div>

<script>
// Datos: se leen del localStorage llamadas_records + datos en vivo de esta sesi√≥n (si existieran)
const STATE = { calls: [] };

function showErr(msg){
  const el = document.getElementById('errbar');
  el.textContent = msg; el.style.display='block'; setTimeout(()=> el.style.display='none', 3000);
}

function loadCalls(){
  let local = [];
  try{ local = JSON.parse(localStorage.getItem('llamadas_records')||'[]'); }catch(_){}
  // normalizar e IDs
  const all = [...local, ...STATE.calls].map(r=>{
    if(!r.__id) r.__id = (r.cod_empresa||'')+'-'+(r.fecha_hora||'')+'-'+Math.random().toString(36).slice(2,7);
    if(!r.estatus_visita) r.estatus_visita = 'programada';
    return r;
  });
  return all.filter(r => r.cita_tipo && r.cita_tipo!=='sin_cita'); // solo con cita
}

function setSelectOptions(id, values){
  const sel = document.getElementById(id);
  const cur = sel.value;
  sel.innerHTML = '<option value="">(todos)</option>' + values.map(v=>`<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join('');
  if(values.includes(cur)) sel.value = cur; // mantener si existe
}
function escapeHtml(s){return String(s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]))}

function buildFilterCombos(){
  const all = loadCalls();
  const vendors = [...new Set(all.map(x=>x.vendedor).filter(Boolean))].sort((a,b)=>String(a).localeCompare(String(b),'es',{numeric:true}));
  const gestores = [...new Set(all.map(x=>x.gestor_servicio).filter(Boolean))].sort((a,b)=>String(a).localeCompare(String(b),'es',{numeric:true}));
  setSelectOptions('fVendedor', vendors);
  setSelectOptions('fGestor', gestores);
}

function filters(){
  return {
    desde: document.getElementById('fDesde').value,
    hasta: document.getElementById('fHasta').value,
    status: document.getElementById('fStatus').value,
    vend: document.getElementById('fVendedor').value,
    gest: document.getElementById('fGestor').value,
  };
}

function applyFilters(data){
  const {desde,hasta,status,vend,gest} = filters();
  const ds = desde? new Date(desde+'T00:00:00') : null;
  const hs = hasta? new Date(hasta+'T23:59:59') : null;
  return data.filter(r=>{
    if(vend && r.vendedor !== vend) return false;
    if(gest && r.gestor_servicio !== gest) return false;
    if(status && (r.estatus_visita||'programada') !== status) return false;
    if(ds || hs){
      const f = r.cita_fecha ? new Date(r.cita_fecha+'T'+(r.cita_hora||'00:00')) : null;
      if(ds && f && f<ds) return false;
      if(hs && f && f>hs) return false;
    }
    return true;
  });
}

function render(){
  buildFilterCombos();
  const all = applyFilters(loadCalls());
  document.getElementById('statCount').textContent = all.length + ' visitas';

  const colHoy = document.getElementById('colHoy'), colSem = document.getElementById('colSemana'), colFut = document.getElementById('colFuturas');
  [colHoy,colSem,colFut].forEach(el=> el.innerHTML='');

  const today = new Date(); today.setHours(0,0,0,0);
  const weekEnd = new Date(today); weekEnd.setDate(today.getDate() + (7 - today.getDay()));

  all.forEach(r=>{
    const f = r.cita_fecha ? new Date(r.cita_fecha+'T'+(r.cita_hora||'00:00')) : null;
    const el = card(r);
    if(!f){ colSem.appendChild(el); return; }
    const d0 = new Date(f); d0.setHours(0,0,0,0);
    if(d0.getTime() === today.getTime()) colHoy.appendChild(el);
    else if(d0 <= weekEnd) colSem.appendChild(el);
    else colFut.appendChild(el);
  });
}

function card(r){
  const div = document.createElement('div');
  div.className = 'card visit';
  div.innerHTML = `
    <div><strong>${escapeHtml(r.cliente||'')}</strong></div>
    <div class="muted">${escapeHtml(r.cod_empresa||'')} ‚Ä¢ ${escapeHtml(r.vendedor||'')} ‚Ä¢ ${escapeHtml(r.gestor_servicio||'')}</div>
    <div class="grid grid-3" style="margin-top:6px">
      <div><label>Fecha</label><input type="date" value="${r.cita_fecha||''}" data-id="${r.__id}" data-k="cita_fecha"></div>
      <div><label>Hora</label><input type="time" value="${r.cita_hora||''}" data-id="${r.__id}" data-k="cita_hora"></div>
      <div><label>Estatus</label>
        <select data-id="${r.__id}" data-k="estatus_visita">
          ${['programada','asisti√≥','no asisti√≥','reprogramada','cancelada'].map(s=>`<option ${((r.estatus_visita||'programada')===s)?'selected':''}>${s}</option>`).join('')}
        </select>
      </div>
    </div>
    <div class="inline" style="justify-content:flex-end;margin-top:8px">
      <button class="btn-primary btn" data-save="${r.__id}">Guardar</button>
    </div>
    <div class="muted" style="margin-top:6px">${escapeHtml(r.observaciones||'')}</div>
  `;
  div.querySelector('[data-save]').addEventListener('click', ()=>{
    const id = div.querySelector('[data-save]').getAttribute('data-save');
    const fecha = div.querySelector(`[data-id="${id}"][data-k="cita_fecha"]`).value;
    const hora  = div.querySelector(`[data-id="${id}"][data-k="cita_hora"]`).value;
    const est   = div.querySelector(`[data-id="${id}"][data-k="estatus_visita"]`).value;
    updateRecord(id,{cita_fecha:fecha,cita_hora:hora,estatus_visita:est});
    showErr('Cita actualizada'); render();
  });
  return div;
}

function updateRecord(id, patch){
  // update localStorage
  let local = [];
  try{ local = JSON.parse(localStorage.getItem('llamadas_records')||'[]'); }catch(_){}
  local = local.map(r=> (r.__id===id ? Object.assign({}, r, patch) : r));
  localStorage.setItem('llamadas_records', JSON.stringify(local));
  // update runtime
  STATE.calls = STATE.calls.map(r=> (r.__id===id ? Object.assign({}, r, patch) : r));
}

function exportCSV(){
  const all = applyFilters(loadCalls());
  const headers = ['Cliente','Cod','Vendedor','Gestor','Fecha','Hora','Estatus','Tipo','Obs'];
  const rows = all.map(r=>[r.cliente||'',r.cod_empresa||'',r.vendedor||'',r.gestor_servicio||'',r.cita_fecha||'',r.cita_hora||'',r.estatus_visita||'programada',r.cita_tipo||'',r.observaciones||'']);
  const csv = [headers.join(','), ...rows.map(row=> row.map(csvEscape).join(','))].join('\n');
  const a = document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8;'})); a.download='visitas_agenda.csv'; a.click(); URL.revokeObjectURL(a.href);
}
function csvEscape(v){ if(v==null) return ''; const s=String(v); return (s.includes(',')||s.includes('"')||s.includes('\n'))?('"'+s.replace(/"/g,'""')+'"'):s; }

// Eventos
['fDesde','fHasta','fStatus','fVendedor','fGestor'].forEach(id=>{
  document.addEventListener('change', e=>{ if(e.target && e.target.id===id) render(); });
});
document.getElementById('btnClear').addEventListener('click', ()=>{
  ['fDesde','fHasta','fStatus','fVendedor','fGestor'].forEach(id=> document.getElementById(id).value='');
  render();
});
document.getElementById('btnExport').addEventListener('click', exportCSV);

// Demo: si no hay data, inyectar 3 visitas de ejemplo para que se vea
(function ensureDemo(){
  let local = [];
  try{ local = JSON.parse(localStorage.getItem('llamadas_records')||'[]'); }catch(_){}
  if(local.filter(r=> r.cita_tipo && r.cita_tipo!=='sin_cita').length===0){
    const today = new Date(); const y=today.getFullYear(), m=String(today.getMonth()+1).padStart(2,'0'), d=String(today.getDate()).padStart(2,'0');
    const fmt = (dt)=> dt.toISOString().slice(0,10);
    const addDays = (n)=>{const t=new Date(); t.setDate(t.getDate()+n); return fmt(t);}
    local.push(
      {__id:'demo1', cliente:'INDUSTRIAS TAVERAS', cod_empresa:'distribuidora342', vendedor:'JOSE', gestor_servicio:'JOSE', observaciones:'visitar showroom', cita_tipo:'cita_showroom', cita_fecha:addDays(0), cita_hora:'10:00', estatus_visita:'programada'},
      {__id:'demo2', cliente:'ANGEL HEREDIA (SBC)', cod_empresa:'distribuidora2437', vendedor:'JOSE', gestor_servicio:'JOSE', observaciones:'visitar showroom', cita_tipo:'cita_showroom', cita_fecha:addDays(3), cita_hora:'11:00', estatus_visita:'programada'},
      {__id:'demo3', cliente:'INKA ACCESORIOS', cod_empresa:'distribuidora2386', vendedor:'DIOGENES', gestor_servicio:'DIOGENES', observaciones:'visitar showroom', cita_tipo:'cita_showroom', cita_fecha:addDays(10), cita_hora:'14:00', estatus_visita:'programada'}
    );
    localStorage.setItem('llamadas_records', JSON.stringify(local));
  }
})();

// Start
render();
</script>
</body>
</html>