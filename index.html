<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Logística 360</title>

<!-- Leaflet & Chart.js & PapaParse -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
:root{
  --bg:#0f172a; --ink:#0b2542; --mut:#6b7280; --card:#ffffff;
  --b:#e5e7eb; --btn:#1da1f2; --btn2:#f7f9fd; --chip:#eef2ff; --chip-a:#216bff;
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:#f3f6fb;color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans",sans-serif}
/* NAV */
.navbar{background:var(--bg);color:#fff;display:flex;align-items:center;gap:.75rem;padding:.55rem 1rem;position:sticky;top:0;z-index:1000}
.navbar .brand{display:flex;align-items:center;gap:.6rem;margin-right:.5rem}
.navbar .brand img{height:30px;border-radius:4px}
.navbar .tab{display:inline-block;text-decoration:none;background:#e7eef9;border:1px solid #dbe7f7;color:#0b2542;border-radius:12px;padding:.45rem .85rem;font-weight:700;cursor:pointer}
.navbar .tab.active{background:#1da1f2;border-color:#18a0fb;color:#fff}
.navbar .spacer{flex:1}
.navbar .btn{background:#22c55e;border:none;color:#fff;border-radius:10px;padding:.45rem .8rem;font-weight:700;cursor:pointer}

/* LAYOUT */
.container{max-width:1200px;margin:0 auto;padding:1rem}
.section{display:none} .section.active{display:block}
h1{margin:.3rem 0 .8rem;font-size:28px}
small.mut{color:var(--mut)}
.card{background:var(--card);border:1px solid var(--b);border-radius:14px;padding:12px}
.row{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
.row > .col-3{grid-column:span 3} .row > .col-4{grid-column:span 4} .row > .col-6{grid-column:span 6}
.row > .col-8{grid-column:span 8} .row > .col-12{grid-column:span 12}
.kpi{background:#fff;border:1px dashed #dde3ee;border-radius:12px;padding:14px}
.kpi .label{color:#51637a;font-size:12px} .kpi .val{font-weight:800;font-size:22px}
.controls{display:flex;gap:.6rem;flex-wrap:wrap}
input,select,textarea{border:1px solid #cbd5e1;border-radius:8px;padding:.45rem .6rem;font-size:14px}
.btn{background:var(--btn);color:#fff;border:none;border-radius:10px;padding:.5rem .9rem;font-weight:700;cursor:pointer}
.btn.secondary{background:var(--btn2);color:#0b2542;border:1px solid #dbe7f7}
.table{width:100%;border-collapse:collapse}
.table th,.table td{border-bottom:1px solid #eef2f7;padding:.45rem .5rem;text-align:left;font-size:14px}
.stickyhead{position:sticky;top:0;background:#f7f9fd}
.chips{display:flex;gap:.5rem;flex-wrap:wrap} .chip{background:var(--chip);border:1px solid #dfe4ff;border-radius:999px;padding:.35rem .6rem;font-size:12px;cursor:pointer}
.chip.active{background:var(--chip-a);color:#fff;border-color:#0f5fff}
#mapPedidos,#mapPlan,#mapRoute{height:420px;border:1px solid #e5e7eb;border-radius:12px}
.badge{display:inline-block;background:#eef2ff;border:1px solid #dfe4ff;border-radius:999px;padding:.15rem .5rem;font-size:12px}
@media (max-width:980px){
  .row{grid-template-columns:repeat(6,1fr)}
  .row > .col-8{grid-column:span 6} .row > .col-6{grid-column:span 6} .row > .col-4{grid-column:span 6} .row > .col-3{grid-column:span 6}
  #mapPedidos,#mapPlan,#mapRoute{height:360px}
}
/* modal */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:1200}
.modal .panel{background:#fff;border-radius:14px;border:1px solid #e5e7eb;max-width:1100px;width:95%;padding:14px}
.modal.show{display:flex}
</style>
</head>
<body>
  <nav class="navbar">
    <div class="brand"><img src="logo.png" alt="logo"/><b>Logística 360</b></div>
    <a class="tab active" data-sec="ped" href="#ped">Pedidos</a>
    <a class="tab" data-sec="desp" href="#desp">Despachos</a>
    <a class="tab" data-sec="ent" href="#ent">Entregas</a>
    <a class="tab" data-sec="inc" href="#inc">Incidencias</a>
    <a class="tab" data-sec="kpi" href="#kpi">KPIs</a>
    <a class="tab" data-sec="aud" href="#aud">Auditoría</a>
    <a class="tab" data-sec="cfg" href="#cfg">Config</a>
    <div class="spacer"></div>
    <button class="btn" id="btnReload">Actualizar</button>
  </nav>

  <div class="container">

    <!-- =================== PEDIDOS =================== -->
    <section id="sec-ped" class="section active">
      <h1>Pedidos & Mapa</h1>
      <small class="mut">Enlace por <b>Cod Empresa</b>. Gestor desde <b>gestor_servicio</b> si falta en pedido.</small>

      <div class="row" style="margin-top:.6rem">
        <div class="col-3"><div class="kpi"><div class="label">Pendientes</div><div class="val" id="kpiPend">—</div></div></div>
        <div class="col-3"><div class="kpi"><div class="label">Hoy</div><div class="val" id="kpiHoy">—</div></div></div>
        <div class="col-3"><div class="kpi"><div class="label">En ruta</div><div class="val" id="kpiRuta">—</div></div></div>
        <div class="col-3"><div class="kpi"><div class="label">Entregados 7d</div><div class="val" id="kpi7">—</div></div></div>
      </div>

      <div class="card" style="margin:.8rem 0">
        <div class="chips" id="chipsEmpresa">
          <div class="chip active" data-emp="">Todas</div>
          <div class="chip" data-emp="karaka">karaka</div>
          <div class="chip" data-emp="distribuidora">distribuidora</div>
        </div>
        <div class="controls" style="margin-top:.6rem">
          <select id="selVendedor"><option value="">Vendedor: Todos</option></select>
          <select id="selGestor"><option value="">Gestor: Todos</option></select>
          <select id="selProv"><option value="">Provincia: Todas</option></select>
          <input id="q" placeholder="buscar pedido/cliente/estado"/>
        </div>
      </div>

      <div class="row">
        <div class="col-8">
          <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.4rem">
              <b>Mapa de Pedidos</b><small id="mapInfo" class="mut"></small>
            </div>
            <div id="mapPedidos"></div>
          </div>
        </div>
        <div class="col-4">
          <div class="card">
            <b>Pedidos</b>
            <div style="max-height:390px;overflow:auto;margin-top:.4rem;border:1px solid #eef2f7;border-radius:10px">
              <table class="table">
                <thead class="stickyhead"><tr><th>Pedido</th><th>Cliente</th><th>Prov.</th><th>Emp.</th></tr></thead>
                <tbody id="tbPed"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- =================== DESPACHOS =================== -->
    <section id="sec-desp" class="section">
      <h1>Planificador de Despachos</h1>
      <div class="card">
        <div class="controls">
          <input type="date" id="despFecha"/>
          <select id="despGestor"><option value="">Gestor</option></select>
          <input id="despChofer" placeholder="Chofer"/>
          <input id="despVeh" placeholder="Vehículo"/>
          <input id="despVent" value="08:00-12:00"/>
          <select id="despEmp"><option value="">Todas</option><option>karaka</option><option>distribuidora</option></select>
          <span class="badge">Filtrados: <b id="pillFiltered">0</b></span>
          <span class="badge">Seleccionados: <b id="pillSelected">0</b></span>
          <span class="badge">Pines: <b id="pillPins">0</b></span>
        </div>

        <div class="row" style="margin-top:.6rem">
          <div class="col-8">
            <div class="card"><div id="mapPlan"></div></div>
          </div>
          <div class="col-4">
            <div class="card">
              <b>Resumen por provincia (filtrado)</b>
              <div style="max-height:360px;overflow:auto;border:1px solid #eef2f7;border-radius:10px;margin-top:.4rem">
                <table class="table"><thead class="stickyhead"><tr><th>Provincia</th><th>Pedidos</th></tr></thead><tbody id="tbodyPlanResumen"></tbody></table>
              </div>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:.6rem">
          <div class="controls">
            <button id="btnPlanSelectAll" class="btn secondary">Seleccionar todo</button>
            <button id="btnPlanClear" class="btn secondary">Limpiar</button>
            <div style="flex:1"></div>
            <button id="btnCrearRuta" class="btn">Crear despacho</button>
          </div>
          <div style="max-height:360px;overflow:auto;border:1px solid #eef2f7;border-radius:10px;margin-top:.4rem">
            <table class="table">
              <thead class="stickyhead">
                <tr><th><input type="checkbox" id="chkAll"/></th><th>Pedido</th><th>Cliente</th><th>Provincia</th><th>Empresa</th></tr>
              </thead>
              <tbody id="tbodyPlanSel"></tbody>
            </table>
          </div>
          <small id="planTotals" class="mut"></small>
        </div>

        <div class="card" style="margin-top:.6rem">
          <b>Rutas creadas</b>
          <div style="max-height:320px;overflow:auto;border:1px solid #eef2f7;border-radius:10px;margin-top:.4rem">
            <table class="table">
              <thead class="stickyhead"><tr><th>Fecha</th><th>Ruta ID</th><th>Gestor</th><th>Chofer</th><th>Vehículo</th><th>Ventana</th><th>Empresas</th><th>Provincias</th><th>Pedidos</th><th>Acciones</th></tr></thead>
              <tbody id="tbodyRutas"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- =================== ENTREGAS =================== -->
    <section id="sec-ent" class="section">
      <h1>Entregas</h1>
      <div class="card">
        <div class="row">
          <div class="col-6">
            <div class="controls">
              <input id="entPedido" placeholder="ID Pedido"/>
              <input id="entCodEmpresa" placeholder="Cod Empresa"/>
              <input id="entCliente" placeholder="Cliente"/>
              <select id="entEstado"><option>Entregado</option><option>Parcial</option><option>No recibido</option></select>
              <textarea id="entObs" placeholder="Observaciones"></textarea>
              <input type="file" id="entFoto" accept="image/*"/>
              <button id="btnGPS" class="btn secondary">Tomar GPS</button>
              <button id="btnEntGuardar" class="btn">Guardar entrega</button>
            </div>
          </div>
          <div class="col-6">
            <b>Entregas registradas (sesión)</b>
            <div style="max-height:360px;overflow:auto;border:1px solid #eef2f7;border-radius:10px;margin-top:.4rem">
              <table class="table">
                <thead class="stickyhead"><tr><th>Fecha</th><th>Pedido</th><th>Cliente</th><th>Estado</th><th>Lat</th><th>Lon</th></tr></thead>
                <tbody id="tbodyEntregas"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- =================== INCIDENCIAS =================== -->
    <section id="sec-inc" class="section">
      <h1>Incidencias</h1>
      <div class="card">
        <div class="controls">
          <input id="incPedido" placeholder="ID Pedido"/>
          <select id="incTipo"><option>Otro</option><option>Dirección incorrecta</option><option>Cliente ausente</option><option>Producto dañado</option></select>
          <input id="incDesc" placeholder="Descripción"/>
          <button id="btnInc" class="btn">Registrar</button>
        </div>
        <div style="max-height:360px;overflow:auto;border:1px solid #eef2f7;border-radius:10px;margin-top:.6rem">
          <table class="table">
            <thead class="stickyhead"><tr><th>Fecha</th><th>Pedido</th><th>Tipo</th><th>Descripción</th></tr></thead>
            <tbody id="tbodyInc"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- =================== KPIs =================== -->
    <section id="sec-kpi" class="section">
      <h1>KPIs</h1>
      <div class="row">
        <div class="col-4"><div class="card"><canvas id="chVend"></canvas></div></div>
        <div class="col-4"><div class="card"><canvas id="chGest"></canvas></div></div>
        <div class="col-4"><div class="card"><canvas id="chProv"></canvas></div></div>
      </div>
    </section>

    <!-- =================== AUDITORÍA =================== -->
    <section id="sec-aud" class="section">
      <h1>Auditoría</h1>
      <div class="card">
        <div style="text-align:right"><button id="btnAudCSV" class="btn secondary">Exportar CSV</button></div>
        <div style="max-height:420px;overflow:auto;border:1px solid #eef2f7;border-radius:10px;margin-top:.3rem">
          <table class="table">
            <thead class="stickyhead"><tr><th>Fecha/Hora</th><th>Usuario/Rol</th><th>Acción</th><th>Entidad</th><th>ID</th><th>Detalle</th></tr></thead>
            <tbody id="tbodyAud"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- =================== CONFIG =================== -->
    <section id="sec-cfg" class="section">
      <h1>Config</h1>
      <div class="card">
        <div class="controls">
          <input id="cfgClientes" placeholder="URL clientes CSV" style="flex:1"/>
          <input id="cfgKaraka" placeholder="URL karaka CSV" style="flex:1"/>
          <input id="cfgDistrib" placeholder="URL distribuidora CSV" style="flex:1"/>
          <button id="btnCfgGuardar" class="btn">Guardar</button>
          <button id="btnCfgReload" class="btn secondary">Recargar data</button>
        </div>
      </div>
    </section>

  </div>

  <!-- Modal Ruta -->
  <div id="modalRuta" class="modal">
    <div class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3>Detalle de Ruta</h3>
        <button id="btnCloseRuta" class="btn secondary">Cerrar</button>
      </div>
      <div class="row" style="margin-top:.5rem">
        <div class="col-6"><div id="mapRoute"></div></div>
        <div class="col-6">
          <div style="max-height:400px;overflow:auto;border:1px solid #eef2f7;border-radius:10px">
            <table class="table">
              <thead class="stickyhead"><tr><th>Pedido</th><th>Cliente</th><th>Prov.</th><th>Emp.</th></tr></thead>
              <tbody id="tbodyRutaDet"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
// ------------------ CONFIG Y ESTADO ------------------
const CONFIG = {
  sheets: {
    clientesCsvUrl: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQt6FhUerc3A1eDpvKdM_KJ2yU8DTXy2MpmaRMeaORqzBxFVY70XzdAw-aL9e10V8l-hsIUKUlj5Ygn/pub?gid=193390473&single=true&output=csv",
    pedidosKarakaCsvUrl: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQt6FhUerc3A1eDpvKdM_KJ2yU8DTXy2MpmaRMeaORqzBxFVY70XzdAw-aL9e10V8l-hsIUKUlj5Ygn/pub?gid=1945180719&single=true&output=csv",
    pedidosDistribuidoraCsvUrl: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQt6FhUerc3A1eDpvKdM_KJ2yU8DTXy2MpmaRMeaORqzBxFVY70XzdAw-aL9e10V8l-hsIUKUlj5Ygn/pub?gid=919779363&single=true&output=csv"
  }
};
const LS = {
  rutas: 'log360_rutas',
  entregas: 'log360_entregas',
  incid: 'log360_incidencias',
  audit: 'log360_audit'
};
const state = {
  clientes: [], pedidos: [], byClient: new Map(),
  ui:{empresa:'',vendedor:'',gestor:'',provincia:'',q:''},
  maps:{ped:null,plan:null,route:null,pedMarkers:[],planMarkers:[],routeMarkers:[]},
  plan:{sel:new Set()},
  charts:{}
};

// ------------------ UTILS ------------------
const norm = s => (s||'').toString().trim().toLowerCase();
function toNum(s){
  if(s==null) return 0;
  const t=(s+'').replace(/[^0-9,.-]/g,'').replace(/,(?=\\d{3}\\b)/g,'');
  const v=parseFloat(t.replace(',','.')); return isNaN(v)?0:v;
}
function uniqueSorted(arr){return [...new Set(arr.filter(Boolean))].sort((a,b)=>norm(a)>norm(b)?1:-1)}
function fmtDate(d=new Date()){return d.toISOString().replace('T',' ').slice(0,19)}

function saveLS(key,arr){localStorage.setItem(key,JSON.stringify(arr||[]))}
function readLS(key){try{return JSON.parse(localStorage.getItem(key)||'[]')}catch{return[]}}

function csvToArray(text){return new Promise(res=>Papa.parse(text,{header:true,skipEmptyLines:true,complete:r=>res(r.data)}))}
async function fetchCsv(url){const r=await fetch(url,{cache:'no-store'}); if(!r.ok) throw new Error('HTTP '+r.status); const t=await r.text(); return csvToArray(t)}

// ------------------ CARGA DE DATA ------------------
async function loadAll(){
  const [cli, kar, dis] = await Promise.all([
    fetchCsv(CONFIG.sheets.clientesCsvUrl),
    fetchCsv(CONFIG.sheets.pedidosKarakaCsvUrl),
    fetchCsv(CONFIG.sheets.pedidosDistribuidoraCsvUrl)
  ]);

  state.clientes = cli.map(r=> ({
    empresa: r['Empresa']||'',
    provincia: r['provincia']||r['Provincia']||'',
    vendedor: r['vendedor']||'',
    gestor: r['gestor_servicio']||r['gestor']||'',
    id: r['id']||'',
    cod: r['Cod Empresa']||r['cod_empresa']||'',
    nombre: r['RazonSocial']||r['razon']||r['cliente']||'',
    lat: parseFloat(r['latitud']||r['lat']||''),
    lon: parseFloat(r['longitud']||r['lon']||'')
  }));
  state.byClient.clear();
  state.clientes.forEach(c=>state.byClient.set(norm(c.cod),c));

  function mapPedido(p, empresa){
    const cod = p['Cod Empresa']||p['cod_empresa']||p['codigo']||'';
    const cli = state.byClient.get(norm(cod));
    return {
      id: p['PEDIDO']||p['Pedido']||p['pedido']||p['Factura N']||p['factura']||'',
      cliente: cli?.nombre || p['CLIENTE']||p['Cliente']||p['cliente']||'',
      codEmpresa: cod,
      empresa,
      estado: p['ESTADO']||p['estado']||p['Status']||'',
      fecha: p['FECHA']||p['Fecha']||p['fecha']||'',
      vendedor: p['vendedor']||p['Vendedor']||'',
      gestor: p['gestor']||p['Gestor']||cli?.gestor||'',
      provincia: cli?.provincia || '',
      lat: cli?.lat, lon: cli?.lon
    };
  }
  state.pedidos = [...kar.map(r=>mapPedido(r,'karaka')), ...dis.map(r=>mapPedido(r,'distribuidora'))];

  buildFilters();
  renderPedidos();
  initMaps();
  renderMapPedidos();
  renderPlanner();
  renderKPIs();
}

// ------------------ FILTROS Y PEDIDOS ------------------
function buildFilters(){
  const ven=uniqueSorted(state.pedidos.map(p=>p.vendedor));
  const ges=uniqueSorted(state.pedidos.map(p=>p.gestor));
  const pr =uniqueSorted(state.pedidos.map(p=>p.provincia));
  document.getElementById('selVendedor').innerHTML='<option value=\"\">Vendedor: Todos</option>'+ven.map(v=>`<option>${v}</option>`).join('');
  document.getElementById('selGestor').innerHTML='<option value=\"\">Gestor: Todos</option>'+ges.map(v=>`<option>${v}</option>`).join('');
  document.getElementById('selProv').innerHTML='<option value=\"\">Provincia: Todas</option>'+pr.map(v=>`<option>${v}</option>`).join('');
  document.getElementById('despGestor').innerHTML='<option value=\"\">Gestor</option>'+ges.map(v=>`<option>${v}</option>`).join('');
}

function applyFilters(){
  const emp=state.ui.empresa, q=norm(state.ui.q);
  return state.pedidos.filter(p=>{
    if(emp && p.empresa!==emp) return false;
    if(state.ui.vendedor && norm(p.vendedor)!==norm(state.ui.vendedor)) return false;
    if(state.ui.gestor && norm(p.gestor)!==norm(state.ui.gestor)) return false;
    if(state.ui.provincia && norm(p.provincia)!==norm(state.ui.provincia)) return false;
    if(q && !(norm(p.id).includes(q)||norm(p.cliente).includes(q)||norm(p.estado).includes(q))) return false;
    return true;
  });
}
function renderPedidos(){
  const rows=applyFilters();
  // KPIs simples
  document.getElementById('kpiPend').textContent = rows.filter(r=>/pend|digit/i.test(r.estado)).length;
  const today=new Date().toISOString().slice(0,10);
  document.getElementById('kpiHoy').textContent = rows.filter(r=> (r.fecha||'').slice(0,10)===today ).length;
  document.getElementById('kpiRuta').textContent = rows.filter(r=>/ruta/i.test(r.estado)).length;
  document.getElementById('kpi7').textContent   = rows.filter(r=>/entreg/i.test(r.estado)).length;

  const tb=document.getElementById('tbPed'); tb.innerHTML='';
  rows.slice(0,600).forEach(p=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${p.id}</td><td>${p.cliente||''}</td><td>${p.provincia||''}</td><td>${p.empresa}</td>`;
    tb.appendChild(tr);
  });
  renderMapPedidos();
}

// ------------------ MAPAS ------------------
function initMaps(){
  if(!state.maps.ped){
    state.maps.ped = L.map('mapPedidos').setView([18.5,-69.9],8);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(state.maps.ped);
  }
  if(!state.maps.plan){
    state.maps.plan = L.map('mapPlan').setView([18.5,-69.9],8);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(state.maps.plan);
  }
  if(!state.maps.route){
    state.maps.route = L.map('mapRoute').setView([18.5,-69.9],8);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(state.maps.route);
  }
}
function clearMarkers(arr){(arr||[]).forEach(m=>m.remove()); arr.length=0;}
function renderMapPedidos(){
  if(!state.maps.ped) return;
  clearMarkers(state.maps.pedMarkers);
  const rows=applyFilters(); let ok=0,no=0;
  rows.forEach(p=>{
    if(p.lat!=null && p.lon!=null && !Number.isNaN(p.lat) && !Number.isNaN(p.lon)){
      const m=L.circleMarker([p.lat,p.lon],{radius:6,weight:1}).addTo(state.maps.ped)
        .bindPopup(`<b>${p.cliente||''}</b><br/>Prov: ${p.provincia||''}<br/>${p.empresa}`);
      state.maps.pedMarkers.push(m); ok++;
    } else no++;
  });
  document.getElementById('mapInfo').textContent=`Filtrados: ${rows.length} • Pines: ${ok} • Sin geo: ${no}`;
}

// ------------------ PLANIFICADOR ------------------
function planRowsFiltered(){
  const emp=document.getElementById('despEmp').value||'';
  return state.pedidos.filter(p=>!emp || p.empresa===emp);
}
function planRender(){
  const rows=planRowsFiltered();
  // resumen provincia
  const agg={}; rows.forEach(p=>{const k=p.provincia||'N/D'; (agg[k]??={ped:0}).ped++;});
  const tb=document.getElementById('tbodyPlanResumen'); tb.innerHTML='';
  Object.entries(agg).sort((a,b)=>b[1].ped-a[1].ped).forEach(([prov,a])=>{
    const tr=document.createElement('tr'); tr.innerHTML=`<td>${prov}</td><td>${a.ped}</td>`; tb.appendChild(tr);
  });
  // tabla seleccionable
  const t2=document.getElementById('tbodyPlanSel'); t2.innerHTML='';
  rows.forEach(p=>{
    const tr=document.createElement('tr');
    const checked=state.plan.sel.has(p.id)?'checked':'';
    tr.innerHTML=`<td><input type="checkbox" data-id="${p.id}" ${checked}></td><td>${p.id}</td><td>${p.cliente||''}</td><td>${p.provincia||''}</td><td>${p.empresa}</td>`;
    t2.appendChild(tr);
  });
  // mapa
  if(state.maps.plan){
    clearMarkers(state.maps.planMarkers);
    const used=new Set(); let pins=0;
    rows.forEach(p=>{
      if(p.lat!=null && p.lon!=null){
        const key=p.lat.toFixed(3)+','+p.lon.toFixed(3);
        if(used.has(key)) return; used.add(key);
        const m=L.circleMarker([p.lat,p.lon],{radius:6,weight:1}).addTo(state.maps.plan)
          .bindPopup(`<b>${p.provincia||''}</b>`);
        state.maps.planMarkers.push(m); pins++;
      }
    });
    document.getElementById('pillPins').textContent=pins;
  }
  document.getElementById('pillFiltered').textContent=rows.length;
  document.getElementById('pillSelected').textContent=state.plan.sel.size;
  // totales texto
  const sel=rows.filter(p=>state.plan.sel.has(p.id));
  document.getElementById('planTotals').textContent=`Seleccionados: ${sel.length} • Provincias: ${uniqueSorted(sel.map(x=>x.provincia)).join(', ')}`;
}
function renderPlanner(){ planRender(); }
document.getElementById('despEmp').addEventListener('change',planRender);
document.getElementById('tbodyPlanSel').addEventListener('change',e=>{
  const cb=e.target.closest('input[type="checkbox"][data-id]'); if(!cb) return;
  if(cb.checked) state.plan.sel.add(cb.dataset.id); else state.plan.sel.delete(cb.dataset.id);
  planRender();
});
document.getElementById('chkAll').addEventListener('change',e=>{
  const rows=planRowsFiltered();
  if(e.target.checked) rows.forEach(p=>state.plan.sel.add(p.id)); else state.plan.sel.clear();
  planRender();
});
document.getElementById('btnPlanSelectAll').addEventListener('click',()=>{
  planRowsFiltered().forEach(p=>state.plan.sel.add(p.id)); planRender();
});
document.getElementById('btnPlanClear').addEventListener('click',()=>{ state.plan.sel.clear(); planRender(); });

// crear ruta
document.getElementById('btnCrearRuta').addEventListener('click',()=>{
  const sel=state.pedidos.filter(p=>state.plan.sel.has(p.id));
  if(sel.length===0){ alert('Seleccione pedidos'); return; }
  const rutaId = 'R'+Date.now().toString().slice(-8);
  const ruta = {
    id:rutaId, fecha:document.getElementById('despFecha').value||new Date().toISOString().slice(0,10),
    gestor:document.getElementById('despGestor').value||'', chofer:document.getElementById('despChofer').value||'',
    vehiculo:document.getElementById('despVeh').value||'', ventana:document.getElementById('despVent').value||'',
    empresas:uniqueSorted(sel.map(p=>p.empresa)).join(', '),
    provincias:uniqueSorted(sel.map(p=>p.provincia)).join(', '),
    pedidos: sel.map(p=>p.id)
  };
  const rutas=readLS(LS.rutas); rutas.unshift(ruta); saveLS(LS.rutas,rutas);
  pushAudit({rol:'planner',accion:'create',entidad:'ruta',id:rutaId,detalle:{gestor:ruta.gestor,chofer:ruta.chofer,vehiculo:ruta.vehiculo,ventana:ruta.ventana,pedidos:ruta.pedidos.length}});
  state.plan.sel.clear(); planRender(); renderRutas(); alert('Despacho creado: '+rutaId);
});
function renderRutas(){
  const rutas=readLS(LS.rutas); const tb=document.getElementById('tbodyRutas'); tb.innerHTML='';
  rutas.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.fecha}</td><td>${r.id}</td><td>${r.gestor||''}</td><td>${r.chofer||''}</td><td>${r.vehiculo||''}</td><td>${r.ventana||''}</td><td>${r.empresas||''}</td><td>${r.provincias||''}</td><td>${r.pedidos.length}</td><td><button class="btn secondary" data-ver="${r.id}">Ver</button></td>`;
    tb.appendChild(tr);
  });
}
document.getElementById('tbodyRutas').addEventListener('click',e=>{
  const id=e.target.getAttribute('data-ver'); if(!id) return;
  const rutas=readLS(LS.rutas); const r=rutas.find(x=>x.id===id); if(!r) return;
  // tabla detalle
  const tb=document.getElementById('tbodyRutaDet'); tb.innerHTML='';
  const rows = state.pedidos.filter(p=>r.pedidos.includes(p.id));
  rows.forEach(p=>{const tr=document.createElement('tr'); tr.innerHTML=`<td>${p.id}</td><td>${p.cliente||''}</td><td>${p.provincia||''}</td><td>${p.empresa}</td>`; tb.appendChild(tr); });
  // mapa
  clearMarkers(state.maps.routeMarkers);
  rows.forEach(p=>{ if(p.lat!=null && p.lon!=null){ const m=L.circleMarker([p.lat,p.lon],{radius:6,weight:1}).addTo(state.maps.route).bindPopup(`<b>${p.cliente||''}</b>`); state.maps.routeMarkers.push(m); } });
  document.getElementById('modalRuta').classList.add('show');
});
document.getElementById('btnCloseRuta').addEventListener('click',()=>document.getElementById('modalRuta').classList.remove('show'));

// ------------------ ENTREGAS ------------------
document.getElementById('btnGPS').addEventListener('click',()=>{
  if(!navigator.geolocation){ alert('GPS no disponible'); return; }
  navigator.geolocation.getCurrentPosition(pos=>{
    document.getElementById('btnGPS').textContent = pos.coords.latitude.toFixed(5)+', '+pos.coords.longitude.toFixed(5);
    document.getElementById('btnGPS').dataset.lat=pos.coords.latitude;
    document.getElementById('btnGPS').dataset.lon=pos.coords.longitude;
  },err=>alert('No se pudo obtener GPS'));
});
document.getElementById('btnEntGuardar').addEventListener('click',()=>{
  const lat=parseFloat(document.getElementById('btnGPS').dataset.lat||'');
  const lon=parseFloat(document.getElementById('btnGPS').dataset.lon||'');
  const rec={
    fecha: fmtDate(), pedido:document.getElementById('entPedido').value||'', cliente:document.getElementById('entCliente').value||'',
    estado: document.getElementById('entEstado').value, lat, lon
  };
  const arr=readLS(LS.entregas); arr.unshift(rec); saveLS(LS.entregas,arr);
  pushAudit({rol:'field',accion:'create',entidad:'entrega',id:rec.pedido,detalle:{estado:rec.estado,lat,lon}});
  renderEntregas(); alert('Entrega registrada');
});
function renderEntregas(){
  const arr=readLS(LS.entregas); const tb=document.getElementById('tbodyEntregas'); tb.innerHTML='';
  arr.forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.fecha}</td><td>${r.pedido}</td><td>${r.cliente||''}</td><td>${r.estado}</td><td>${r.lat||''}</td><td>${r.lon||''}</td>`; tb.appendChild(tr); });
}

// ------------------ INCIDENCIAS ------------------
document.getElementById('btnInc').addEventListener('click',()=>{
  const rec={fecha:fmtDate(),pedido:document.getElementById('incPedido').value||'',tipo:document.getElementById('incTipo').value,desc:document.getElementById('incDesc').value||''};
  const arr=readLS(LS.incid); arr.unshift(rec); saveLS(LS.incid,arr);
  pushAudit({rol:'ops',accion:'create',entidad:'incidencia',id:rec.pedido,detalle:{tipo:rec.tipo,desc:rec.desc}});
  renderIncidencias(); alert('Incidencia guardada');
});
function renderIncidencias(){
  const arr=readLS(LS.incid); const tb=document.getElementById('tbodyInc'); tb.innerHTML='';
  arr.forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.fecha}</td><td>${r.pedido}</td><td>${r.tipo}</td><td>${r.desc||''}</td>`; tb.appendChild(tr); });
}

// ------------------ KPIs ------------------
function renderKPIs(){
  const rows=state.pedidos;
  const by = (key)=>{
    const m={}; rows.forEach(p=>{const k=p[key]||'N/D'; m[k]=(m[k]||0)+1}); 
    const labels=Object.keys(m); const data=labels.map(k=>m[k]);
    return {labels,data};
  }
  const vend=by('vendedor'), gest=by('gestor'), prov=by('provincia');
  const cfg=(ctx,lab,data)=> new Chart(ctx,{type:'bar',data:{labels:lab,datasets:[{label:'Pedidos',data}]},options:{plugins:{legend:{display:false}},scales:{x:{ticks:{autoSkip:false,maxRotation:65,minRotation:45}}}});
  state.charts.v = state.charts.v || cfg(document.getElementById('chVend'), vend.labels, vend.data);
  state.charts.g = state.charts.g || cfg(document.getElementById('chGest'), gest.labels, gest.data);
  state.charts.p = state.charts.p || cfg(document.getElementById('chProv'), prov.labels, prov.data);
}

// ------------------ AUDITORÍA ------------------
function pushAudit(evt){
  const arr=readLS(LS.audit); arr.unshift({ts:fmtDate(),...evt}); saveLS(LS.audit,arr); renderAudit();
}
function renderAudit(){
  const tb=document.getElementById('tbodyAud'); if(!tb) return;
  const arr=readLS(LS.audit); tb.innerHTML='';
  arr.forEach(a=>{ const tr=document.createElement('tr'); 
    const detalle = Object.entries(a.detalle||{}).map(([k,v])=>k+': '+v).join(' | ');
    tr.innerHTML=`<td>${a.ts}</td><td>${a.rol}</td><td>${a.accion}</td><td>${a.entidad}</td><td>${a.id||''}</td><td>${detalle}</td>`; 
    tb.appendChild(tr);
  });
}
document.getElementById('btnAudCSV').addEventListener('click',()=>{
  const arr=readLS(LS.audit);
  const rows=[['fecha_hora','rol','accion','entidad','id','detalle']].concat(arr.map(a=>[a.ts,a.rol,a.accion,a.entidad,a.id,JSON.stringify(a.detalle||{})]));
  const csv = rows.map(r=>r.map(x=>`"${(x||'').toString().replaceAll('"','""')}"`).join(',')).join('\\n');
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='auditoria.csv'; a.click(); URL.revokeObjectURL(url);
});

// ------------------ CONFIG ------------------
function loadConfigToUI(){
  document.getElementById('cfgClientes').value = CONFIG.sheets.clientesCsvUrl;
  document.getElementById('cfgKaraka').value = CONFIG.sheets.pedidosKarakaCsvUrl;
  document.getElementById('cfgDistrib').value = CONFIG.sheets.pedidosDistribuidoraCsvUrl;
}
document.getElementById('btnCfgGuardar').addEventListener('click',()=>{
  CONFIG.sheets.clientesCsvUrl = document.getElementById('cfgClientes').value.trim();
  CONFIG.sheets.pedidosKarakaCsvUrl = document.getElementById('cfgKaraka').value.trim();
  CONFIG.sheets.pedidosDistribuidoraCsvUrl = document.getElementById('cfgDistrib').value.trim();
  alert('Guardado. Use "Recargar data".');
});
document.getElementById('btnCfgReload').addEventListener('click',()=>{ loadAll().catch(e=>alert('Error: '+e.message)); });

// ------------------ INTERACCIONES & NAV ------------------

// Navegación robusta por hash + click (accesible)
function showSection(sec){
  document.querySelectorAll('.navbar .tab').forEach(x=>x.classList.remove('active'));
  const act = document.querySelector('.navbar .tab[data-sec="'+sec+'"]');
  if(act) act.classList.add('active');
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  const el = document.getElementById('sec-'+sec) || document.getElementById('sec-ped');
  el.classList.add('active');
  if(sec==='ped'){ initMaps(); renderMapPedidos(); }
  if(sec==='desp'){ initMaps(); renderPlanner(); renderRutas(); }
  if(sec==='ent'){ renderEntregas(); }
  if(sec==='inc'){ renderIncidencias(); }
  if(sec==='aud'){ renderAudit(); }
  if(sec==='cfg'){ loadConfigToUI(); }
}
document.querySelectorAll('.navbar .tab').forEach(a=>a.addEventListener('click',e=>{
  e.preventDefault();
  const sec=e.currentTarget.dataset.sec||'ped';
  if(location.hash!==('#'+sec)) location.hash = sec;
  else showSection(sec);
}));
window.addEventListener('hashchange',()=>{
  const sec=(location.hash||'').replace('#','')||'ped';
  showSection(sec);
});
// Inicializa según hash
showSection((location.hash||'').replace('#','')||'ped');
;
document.getElementById('btnReload').addEventListener('click',()=>loadAll().catch(e=>alert('Error al recargar: '+e.message)));

document.getElementById('chipsEmpresa').addEventListener('click',e=>{
  const chip=e.target.closest('.chip'); if(!chip) return;
  document.querySelectorAll('#chipsEmpresa .chip').forEach(c=>c.classList.remove('active'));
  chip.classList.add('active'); state.ui.empresa = chip.dataset.emp||''; renderPedidos();
});
['selVendedor','selGestor','selProv','q'].forEach(id=>{
  document.getElementById(id).addEventListener('input',()=>{
    state.ui.vendedor = document.getElementById('selVendedor').value||'';
    state.ui.gestor    = document.getElementById('selGestor').value||'';
    state.ui.provincia = document.getElementById('selProv').value||'';
    state.ui.q         = document.getElementById('q').value||'';
    renderPedidos();
  });
});

// ------------------ START ------------------
loadAll().catch(err=>{ alert('No se pudo cargar la data: '+err.message); console.error(err); });
renderRutas(); renderEntregas(); renderIncidencias(); renderAudit();

</script>

<script>
// ====== NAV: a prueba de balas (click + hash + accesible) ======
(function(){
  function showSection(sec){
    // Normaliza valor
    sec = (sec||'').trim() || 'ped';
    // Tabs
    document.querySelectorAll('.navbar .tab').forEach(x=>x.classList.remove('active'));
    const tab = document.querySelector('.navbar .tab[data-sec="'+sec+'"]');
    if(tab) tab.classList.add('active');
    // Secciones
    document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
    const el = document.getElementById('sec-'+sec) || document.getElementById('sec-ped');
    if(el) el.classList.add('active');
    // Hooks
    try{
      if(sec==='ped'){ initMaps && initMaps(); renderMapPedidos && renderMapPedidos(); }
      if(sec==='desp'){ initMaps && initMaps(); renderPlanner && renderPlanner(); renderRutas && renderRutas(); }
      if(sec==='ent'){ renderEntregas && renderEntregas(); }
      if(sec==='inc'){ renderIncidencias && renderIncidencias(); }
      if(sec==='aud'){ renderAudit && renderAudit(); }
      if(sec==='cfg'){ loadConfigToUI && loadConfigToUI(); }
    }catch(e){ console.warn('nav hook:', e); }
  }
  // Click en tabs
  document.querySelectorAll('.navbar .tab').forEach(a=>a.addEventListener('click', function(ev){
    ev.preventDefault();
    const sec = this.dataset.sec || (this.getAttribute('href')||'').replace('#','') || 'ped';
    if(location.hash !== '#'+sec){ location.hash = sec; } else { showSection(sec); }
  }));
  // Hash directo o al cambiar
  window.addEventListener('hashchange', function(){ showSection((location.hash||'').replace('#','')||'ped'); });
  // Inicio
  showSection((location.hash||'').replace('#','')||'ped');
})();
</script>

</body>
</html>
