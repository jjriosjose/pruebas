<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Logística 360 — Empresarial</title>

<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<!-- PapaParse -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
:root{ --ink:#0b3a55; --brand:#0ea5e9; --brand2:#2563eb; --bg:#f5f7fb }
body{background:var(--bg);color:#0f172a}
.navbar{background:#0f172a;color:#e5eef9;position:sticky;top:0;z-index:50}
.kpi{background:#fff;border:1px solid #e5e7eb;border-radius:.8rem;padding:.8rem 1rem}
.card{background:#fff;border:1px solid #e5e7eb;border-radius:.8rem}
.btn{background:var(--brand);color:#fff;border-radius:.55rem;padding:.45rem .85rem}
.btn.secondary{background:#e5e7eb;color:#0f172a}
.btn.danger{background:#ef4444}
.btn.warn{background:#f59e0b}
.btn:hover{filter:brightness(.95)}
.tab{border:1px solid #e5e7eb;border-radius:.6rem;padding:.4rem .75rem;background:#fff;cursor:pointer;white-space:nowrap}
.tab.active{background:#0ea5e9;color:#fff;border-color:#0ea5e9}
.chip{border:1px solid #e5e7eb;border-radius:9999px;padding:.2rem .55rem;background:#fff;cursor:pointer;white-space:nowrap}
.chip.active{background:#2563eb;color:#fff;border-color:#2563eb}
.badge{background:#eef6ff;border:1px solid #dbeafe;color:#0b3a55;border-radius:9999px;padding:2px 10px;font-size:12px}
#map{height:52vh;border-radius:.8rem;border:1px solid #e5e7eb}
@media (min-width: 768px){ #map{height:60vh} }
#miniMap{height:40vh;border-radius:.8rem;border:1px solid #e5e7eb}
.table th{font-size:.8rem;text-transform:uppercase;color:#334155;background:#f3f4f6}
.table td{border-top:1px solid #f1f5f9}
.link{color:#2563eb;cursor:pointer;text-decoration:underline}
.toast{position:fixed;right:1rem;bottom:1rem;background:#111827;color:#f9fafb;border:1px solid #1f2937;border-radius:.6rem;padding:.6rem .8rem;display:none;z-index:9999}
.toast.show{display:block}
.debug{font-size:11px;color:#64748b}
.section{display:none}
.section.active{display:block}
input, select, textarea{background:#fff}
fieldset{border:1px dashed #e5e7eb;padding:10px;border-radius:.6rem}
legend{color:#64748b;font-size:12px;padding:0 6px}
canvas.sig{border:1px solid #e5e7eb;border-radius:.5rem;background:#fff}
.preview{max-height:140px;border:1px solid #e5e7eb;border-radius:.5rem}
.sticky-sub{position:sticky;top:56px;z-index:40;background:#fff}

/* TMS planner styling */
#secDespachos .tms-toolbar{display:flex;gap:.5rem;align-items:center;justify-content:space-between;margin-bottom:.5rem}
#secDespachos .tms-title{font-weight:600;font-size:1.05rem;color:var(--ink)}
#secDespachos .tms-pills{display:flex;gap:.5rem;flex-wrap:wrap}
#secDespachos .tms-pill{background:#f4f6fb;border:1px solid #e5e7ef;color:#2a3547;border-radius:999px;padding:.35rem .6rem;font-size:.78rem;display:flex;align-items:center;gap:.4rem}
#secDespachos .tms-pill b{font-weight:700}
#secDespachos .tms-grid{display:grid;grid-template-columns:repeat(12,1fr);gap:.75rem}
#secDespachos .tms-card{background:#fff;border:1px solid #e8ebf2;border-radius:12px;padding:12px}
#secDespachos .tms-field{display:flex;flex-direction:column;gap:.2rem}
#secDespachos label{font-size:.72rem;color:#6b7280}
#secDespachos input,#secDespachos select{border:1px solid #d8dbe4;border-radius:8px;padding:.45rem .55rem;font-size:.9rem}
#secDespachos .tms-section-title{font-weight:600;font-size:.92rem;color:#1f2937;margin:.35rem 0 .25rem}
#secDespachos #mapPlan{height:44vh;border:1px solid #e5e7eb;border-radius:12px}
#secDespachos .tms-table-wrap{border:1px solid #e8ebf2;border-radius:12px;overflow:auto;background:#fff;max-height:38vh}
#secDespachos table thead th{position:sticky;top:0;background:#f7f8fb;border-bottom:1px solid #e8ebf2;font-weight:600}
#secDespachos table td,#secDespachos table th{font-size:.86rem}
#secDespachos .tms-actions{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
@media (max-width:980px){
  #secDespachos .tms-grid{grid-template-columns:repeat(6,1fr)}
  #secDespachos #mapPlan{height:36vh}
}

/* keep navbar clickable above planner */
.navbar{position:relative;z-index:50;pointer-events:auto}

/* nav fix z */
.navbar{position:sticky;top:0;z-index:9999;pointer-events:auto}
.section{position:relative;z-index:1}
</style>
</head>
<body>
<nav class="navbar">
  <div class="max-w-7xl mx-auto flex items-center justify-between p-3">
    <div class="flex items-center gap-3">
      <img src="./logo.png" class="h-8 w-8 object-contain" alt="Logo"/>
      <div class="text-lg font-semibold">Logística 360</div>
    </div>
    <div class="flex gap-3 items-center text-xs sm:text-sm">
      <div class="hidden sm:block" id="lastUpdate"></div>
      <button id="refreshBtn" class="btn">Actualizar</button>
    </div>
  </div>
  <div class="max-w-7xl mx-auto p-2 flex flex-wrap gap-2">
    <button class="tab active" data-section="secPedidos">Pedidos</button>
    <button class="tab" data-section="secDespachos">Despachos</button>
    <button class="tab" data-section="secEntregas">Entregas</button>
    <button class="tab" data-section="secIncidencias">Incidencias</button>
    <button class="tab" data-section="secKPIs">KPIs</button>
    <button class="tab" data-section="secAuditoria">Auditoría</button>
    <button class="tab" data-section="secConfig">Config</button>
  </div>
</nav>
<script>
// --- Micro binder for tabs & chips (resilient) ---
(function(){
  const $$=(s,ctx=document)=>Array.from(ctx.querySelectorAll(s));
  function showSection(id){
    $$('.section').forEach(s=>s.classList.remove('active'));
    const sec=document.getElementById(id); if(sec) sec.classList.add('active');
  }
  document.addEventListener('click', function(e){
    const navBtn = e.target.closest('nav .tab[data-section]');
    if(navBtn){
      e.preventDefault();
      $$('.navbar .tab').forEach(x=>x.classList.remove('active'));
      navBtn.classList.add('active');
      showSection(navBtn.dataset.section);
      try{ if(navBtn.dataset.section==='secDespachos'){ setTimeout(()=>{ if(window.updateMiniMap) updateMiniMap(); }, 100); } }catch{}
      return;
    }
    const pedTab = e.target.closest('#secPedidos .tab[data-tab]');
    if(pedTab){
      e.preventDefault();
      $$('#secPedidos .tab[data-tab]').forEach(x=>x.classList.remove('active'));
      pedTab.classList.add('active');
      try{ window.state && (state.ui.tab = pedTab.dataset.tab); if(window.renderAll) renderAll(); if(window.refreshPlanner) refreshPlanner(); }catch{}
      return;
    }
    const empChip = e.target.closest('#secPedidos .chip');
    if(empChip){
      e.preventDefault();
      $$('#secPedidos .chip').forEach(x=>x.classList.remove('active'));
      empChip.classList.add('active');
      try{ window.state && (state.ui.empresa = empChip.dataset.empresa||''); if(window.renderAll) renderAll(); if(window.refreshPlanner) refreshPlanner(); }catch{}
      return;
    }
  }, true);
})();
</script>


<!-- PEDIDOS -->
<section id="secPedidos" class="section active">
  <header class="bg-white border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4 py-4 sm:py-5">
      <h1 class="text-xl sm:text-2xl font-bold" style="color:var(--ink)">Pedidos & Mapa</h1>
      <p class="text-xs sm:text-sm text-gray-500">Enlace por <b>Cod Empresa</b>. Gestor desde <b>gestor_servicio</b> cuando falte en pedido.</p>
    </div>
  </header>

  <main class="max-w-7xl mx-auto p-3 sm:p-4 space-y-4">
    <section class="grid grid-cols-2 md:grid-cols-4 gap-3">
      <div class="kpi"><div class="text-xs sm:text-sm">Pendientes</div><div id="kpiPendientes" class="text-xl sm:text-2xl font-semibold">—</div></div>
      <div class="kpi"><div class="text-xs sm:text-sm">Hoy</div><div id="kpiHoy" class="text-xl sm:text-2xl font-semibold">—</div></div>
      <div class="kpi"><div class="text-xs sm:text-sm">En ruta</div><div id="kpiRuta" class="text-xl sm:text-2xl font-semibold">—</div></div>
      <div class="kpi"><div class="text-xs sm:text-sm">Entregados 7d</div><div id="kpiEntregados" class="text-xl sm:text-2xl font-semibold">—</div></div>
    </section>

    <section class="card p-3">
      <div class="flex flex-wrap gap-2 items-center">
        <div class="tab active" data-tab="todos">Todos</div>
        <div class="tab" data-tab="pendientes">Pendientes</div>
        <div class="tab" data-tab="facturados">Facturados</div>
        <div class="tab" data-tab="entregados">Entregados</div>

        <div class="w-full md:w-auto"></div>

        <div class="flex items-center gap-2 text-xs sm:text-sm">
          <span>Empresa:</span>
          <span class="chip active" data-empresa="">Todas</span>
          <span class="chip" data-empresa="karaka">karaka</span>
          <span class="chip" data-empresa="distribuidora">distribuidora</span>
        </div>

        <div class="flex items-center gap-2 text-xs sm:text-sm">
          <label class="text-gray-600" for="selVendedor">Vendedor:</label>
          <select id="selVendedor" class="border border-gray-300 rounded-md px-2 sm:px-3 py-1 bg-white"><option value="">Todos</option></select>
          <label class="text-gray-600 ml-1 sm:ml-2" for="selGestor">Gestor:</label>
          <select id="selGestor" class="border border-gray-300 rounded-md px-2 sm:px-3 py-1 bg-white"><option value="">Todos</option></select>
          <label class="text-gray-600 ml-1 sm:ml-2" for="selProvincia">Provincia:</label>
          <select id="selProvincia" class="border border-gray-300 rounded-md px-2 sm:px-3 py-1 bg-white"><option value="">Todas</option></select>
        </div>

        <div class="flex items-center gap-2 ml-auto">
          <input id="q" type="search" class="border border-gray-300 rounded-md px-2 sm:px-3 py-1 w-44 sm:w-64 bg-white" placeholder="Buscar pedido/cliente/estado">
          <input id="fDesde" type="date" class="border border-gray-300 rounded-md px-2 sm:px-3 py-1 bg-white">
          <input id="fHasta" type="date" class="border border-gray-300 rounded-md px-2 sm:px-3 py-1 bg-white">
        </div>
      </div>
      <div class="mt-2 debug" id="helpText"></div>
    </section>

    <section class="card p-3">
      <div class="flex items-center justify-between">
        <h3 class="font-semibold text-sm sm:text-base" style="color:var(--ink)">🗺️ Mapa de Pedidos</h3>
        <div class="flex items-center gap-4">
          <div class="debug" id="debugText"></div>
          <button id="toggleMap" class="link text-xs sm:text-sm">Ocultar mapa</button>
        </div>
      </div>
      <div id="mapWrap"><div id="map"></div></div>
    </section>

    <section class="grid lg:grid-cols-3 gap-4">
      <div class="lg:col-span-2 card">
        <div class="flex items-center justify-between p-3">
          <h3 class="font-semibold text-sm sm:text-base" style="color:var(--ink)">📋 Pedidos</h3>
          <button id="toggleTable" class="link text-xs sm:text-sm">Ocultar tabla</button>
        </div>
        <div id="tableWrap" class="overflow-auto">
          <table class="w-full table min-w-[1000px]">
            <thead id="theadPedidos"></thead>
            <tbody id="tbody" class="text-xs sm:text-sm"></tbody>
          </table>
        </div>
        <div class="p-3 debug" id="mismatch"></div>
      </div>
      <div class="card p-3">
        <h3 class="font-semibold mb-2 text-sm sm:text-base" style="color:var(--ink)">📊 Estados</h3>
        <canvas id="chartEstados" height="220"></canvas>
      </div>
    </section>
  </main>
</section>


<!-- DESPACHOS -->
<section id="secDespachos" class="section">
  <div class="max-w-7xl mx-auto p-3 sm:p-4 space-y-3">

    <div class="tms-toolbar">
      <div class="tms-title">Planificador de Despachos</div>
      <div class="tms-pills">
        <div class="tms-pill">Filtrados: <b id="pillFiltered">0</b></div>
        <div class="tms-pill">Seleccionados: <b id="pillSelected">0</b></div>
        <div class="tms-pill">Bultos: <b id="pillBultos">0</b></div>
        <div class="tms-pill">Valor: <b id="pillValor">0</b></div>
        <div class="tms-pill">Pines: <b id="pillPins">0</b></div>
      </div>
    </div>

    <!-- Parámetros y Filtros -->
    <div class="tms-card">
      <div class="tms-grid">
        <div class="tms-field col-span-2">
          <label>Fecha</label>
          <input type="date" id="despFecha" />
        </div>
        <div class="tms-field col-span-2">
          <label>Gestor</label>
          <select id="despGestor"><option value="">Seleccione</option></select>
        </div>
        <div class="tms-field col-span-2">
          <label>Chofer</label>
          <input id="despChofer" list="dlChoferes" placeholder="Nombre del chofer" />
          <datalist id="dlChoferes"></datalist>
        </div>
        <div class="tms-field col-span-2">
          <label>Vehículo</label>
          <input id="despVehiculo" placeholder="Placa / Interno" />
        </div>
        <div class="tms-field col-span-2">
          <label>Ventana Horaria</label>
          <input id="despVentana" value="08:00-12:00" />
        </div>

        <div class="tms-field col-span-2">
          <label>Empresa</label>
          <select id="despEmp">
            <option value="">Todas</option>
            <option value="karaka">karaka</option>
            <option value="distribuidora">distribuidora</option>
          </select>
        </div>
        <div class="tms-field col-span-2">
          <label>Vendedor</label>
          <select id="despFiltroVendedor"><option value="">Todos</option></select>
        </div>
        <div class="tms-field col-span-2">
          <label>Gestor (filtro)</label>
          <select id="despFiltroGestor"><option value="">Todos</option></select>
        </div>
        <div class="tms-field col-span-2">
          <label>Provincia</label>
          <select id="despFiltroProv"><option value="">Todas</option></select>
        </div>
        <div class="tms-field col-span-4">
          <label>Buscar</label>
          <input id="despQ" placeholder="pedido / cliente / código" />
        </div>
      </div>
    </div>

    <!-- Mapa + Resumen -->
    <div class="tms-grid">
      <div class="col-span-8 tms-card">
        <div class="tms-section-title">Mapa de planificación</div>
        <div id="mapPlan"></div>
        <div id="despMapInfo" class="debug mt-1"></div>
      </div>
      <div class="col-span-4 tms-card">
        <div class="tms-section-title">Resumen por provincia (filtrado)</div>
        <div class="tms-table-wrap">
          <table class="w-full table">
            <thead><tr>
              <th class="text-left px-2 py-1">Provincia</th>
              <th class="text-right px-2 py-1">Pedidos</th>
              <th class="text-right px-2 py-1">Bultos</th>
              <th class="text-right px-2 py-1">Valor</th>
            </tr></thead>
            <tbody id="tbodyPlanResumen"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Selección de pedidos -->
    <div class="tms-card">
      <div class="tms-section-title">Seleccionar pedidos</div>
      <div class="tms-actions">
        <label class="text-xs text-gray-600">Acciones rápidas</label>
        <button id="btnPlanSelectAll" class="btn secondary text-xs">Seleccionar todo</button>
        <button id="btnPlanClear" class="btn secondary text-xs">Limpiar selección</button>
        <div class="ml-auto flex gap-2">
          <button id="btnCrearDespacho" class="btn">Crear despacho</button>
          <button id="btnExportDespachos" class="btn secondary">Exportar CSV (todos)</button>
        </div>
      </div>
      <div class="tms-table-wrap mt-2">
        <table class="w-full table min-w-[900px]">
          <thead>
            <tr>
              <th class="px-2 py-2"><input type="checkbox" id="chkPlanAll"/></th>
              <th class="text-left px-2 py-2">Pedido</th>
              <th class="text-left px-2 py-2">Cliente</th>
              <th class="text-left px-2 py-2">Provincia</th>
              <th class="text-left px-2 py-2">Empresa</th>
              <th class="text-right px-2 py-2">Bultos</th>
              <th class="text-right px-2 py-2">Valor</th>
            </tr>
          </thead>
          <tbody id="tbodyPlanSel"></tbody>
        </table>
      </div>
      <div id="planTotals" class="debug mt-1"></div>
    </div>

    <!-- Rutas creadas -->
    <div class="tms-card">
      <div class="tms-section-title">Rutas creadas</div>
      <div class="tms-table-wrap">
        <table class="w-full table min-w-[1100px]">
          <thead><tr>
            <th class="text-left px-2 py-2">Fecha</th>
            <th class="text-left px-2 py-2">Ruta ID</th>
            <th class="text-left px-2 py-2">Gestor</th>
            <th class="text-left px-2 py-2">Chofer</th>
            <th class="text-left px-2 py-2">Vehículo</th>
            <th class="text-left px-2 py-2">Ventana</th>
            <th class="text-left px-2 py-2">Empresa(s)</th>
            <th class="text-left px-2 py-2">Provincia(s)</th>
            <th class="text-right px-2 py-2">Pedidos</th>
            <th class="text-right px-2 py-2">Bultos</th>
            <th class="text-right px-2 py-2">Valor</th>
            <th class="text-left px-2 py-2">Estado Ruta</th>
            <th class="text-left px-2 py-2">Acciones</th>
          </tr></thead>
          <tbody id="tbodyDespachos"></tbody>
        </table>
      </div>
    </div>

  </div>
</section>

<!-- Modal Ruta (se conserva) -->
<div id="routeModal" class="fixed inset-0 bg-black/50 hidden z-[100]">
  <div class="max-w-5xl mx-auto bg-white rounded-xl p-4 mt-16 shadow-lg">
    <div class="flex items-center justify-between">
      <h3 class="font-semibold" style="color:var(--ink)">Detalle de Ruta</h3>
      <div class="flex gap-2">
        <button id="btnCloseRoute" class="btn text-xs">Cerrar</button>
      </div>
    </div>
    <div class="grid md:grid-cols-2 gap-3 mt-3">
      <div><div id="mapRoute" style="height:45vh;border:1px solid #e5e7eb;border-radius:.8rem;"></div></div>
      <div>
        <div id="routeInfo" class="text-xs sm:text-sm"></div>
        <div class="overflow-auto max-h-[40vh] mt-2">
          <table class="w-full table min-w-[700px]">
            <thead><tr>
              <th class="text-left px-2 py-1">Pedido</th>
              <th class="text-left px-2 py-1">Cliente</th>
              <th class="text-left px-2 py-1">Provincia</th>
              <th class="text-right px-2 py-1">Bultos</th>
              <th class="text-right px-2 py-1">Valor</th>
            </tr></thead>
            <tbody id="tbodyRouteDetail"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>


<!-- ENTREGAS -->
<section id="secEntregas" class="section">
  <div class="max-w-7xl mx-auto p-3 sm:p-4 space-y-4">
    <div class="card p-3">
      <h3 class="font-semibold text-sm sm:text-base" style="color:var(--ink)">Entrega en Ruta (Foto + Firma + GPS)</h3>
      <div class="grid md:grid-cols-3 gap-3">
        <div>
          <label class="text-xs text-gray-600">Pedido</label>
          <input list="dlPedidos" id="entPedidoId" class="w-full border border-gray-300 rounded-md px-2 py-1" placeholder="ID Pedido"/>
          <datalist id="dlPedidos"></datalist>
        </div>
        <div>
          <label class="text-xs text-gray-600">Cod Empresa</label>
          <input id="entCodEmp" class="w-full border border-gray-300 rounded-md px-2 py-1" readonly/>
        </div>
        <div>
          <label class="text-xs text-gray-600">Cliente</label>
          <input id="entCliente" class="w-full border border-gray-300 rounded-md px-2 py-1" readonly/>
        </div>
        <div>
          <label class="text-xs text-gray-600">Empresa</label>
          <input id="entEmpresa" class="w-full border border-gray-300 rounded-md px-2 py-1" readonly/>
        </div>
        <div>
          <label class="text-xs text-gray-600">Gestor</label>
          <input id="entGestor" class="w-full border border-gray-300 rounded-md px-2 py-1" readonly/>
        </div>
        <div>
          <label class="text-xs text-gray-600">Estado de entrega</label>
          <select id="entEstado" class="w-full border border-gray-300 rounded-md px-2 py-1">
            <option>Entregado</option>
            <option>Entregado Parcial</option>
            <option>Devuelto</option>
            <option>Reprogramado</option>
          </select>
        </div>
        <div>
          <label class="text-xs text-gray-600">Observaciones</label>
          <textarea id="entObs" class="w-full border border-gray-300 rounded-md px-2 py-1" rows="2" placeholder="Notas de entrega"></textarea>
        </div>
        <div>
          <label class="text-xs text-gray-600">Foto factura/entrega</label>
          <input id="entFoto" type="file" accept="image/*" capture="environment" class="w-full"/>
          <img id="entFotoPrev" class="preview mt-1"/>
        </div>
        <div>
          <label class="text-xs text-gray-600">Firma del cliente</label>
          <div class="space-y-1">
            <canvas id="entFirma" class="sig" width="300" height="150"></canvas><br/>
            <button id="btnClearFirma" class="btn secondary text-xs">Limpiar firma</button>
          </div>
        </div>
        <div>
          <label class="text-xs text-gray-600">Ubicación</label>
          <div class="flex gap-2">
            <button id="btnGPS" class="btn">Tomar GPS</button>
            <div id="entGPS" class="text-xs text-gray-600 self-center"></div>
          </div>
        </div>
      </div>
      <div class="mt-3 flex gap-2">
        <button id="btnGuardarEntrega" class="btn">Guardar entrega</button>
        <button id="btnExportEntregas" class="btn secondary">Exportar CSV</button>
      </div>
    </div>

    <div class="card p-3">
      <h3 class="font-semibold text-sm sm:text-base" style="color:var(--ink)">Entregas registradas (sesión)</h3>
      <div class="overflow-auto">
        <table class="w-full table min-w-[1000px]">
          <thead><tr>
            <th class="text-left px-2 py-2">Fecha/Hora</th>
            <th class="text-left px-2 py-2">Pedido</th>
            <th class="text-left px-2 py-2">Cliente</th>
            <th class="text-left px-2 py-2">Gestor</th>
            <th class="text-left px-2 py-2">Estado</th>
            <th class="text-left px-2 py-2">Lat</th><th class="text-left px-2 py-2">Lon</th><th class="text-left px-2 py-2">Prec.</th>
            <th class="text-left px-2 py-2">Obs</th>
            <th class="text-left px-2 py-2">Foto</th>
            <th class="text-left px-2 py-2">Firma</th>
          </tr></thead>
          <tbody id="tbodyEntregas" class="text-xs sm:text-sm"></tbody>
        </table>
      </div>
    </div>
  </div>
</section>

<!-- INCIDENCIAS -->
<section id="secIncidencias" class="section">
  <div class="max-w-7xl mx-auto p-3 sm:p-4 space-y-4">
    <div class="card p-3">
      <h3 class="font-semibold text-sm sm:text-base" style="color:var(--ink)">Incidencias / Devoluciones</h3>
      <div class="grid md:grid-cols-3 gap-3">
        <div>
          <label class="text-xs text-gray-600">Pedido</label>
          <input list="dlPedidos2" id="incPedidoId" class="w-full border border-gray-300 rounded-md px-2 py-1"/>
          <datalist id="dlPedidos2"></datalist>
        </div>
        <div>
          <label class="text-xs text-gray-600">Tipo</label>
          <select id="incTipo" class="w-full border border-gray-300 rounded-md px-2 py-1">
            <option>No ubicado</option><option>Cliente ausente</option><option>Dirección incorrecta</option><option>Dañado</option><option>Reprogramado</option><option>Otro</option>
          </select>
        </div>
        <div>
          <label class="text-xs text-gray-600">Descripción</label>
          <textarea id="incDesc" class="w-full border border-gray-300 rounded-md px-2 py-1" rows="2"></textarea>
        </div>
        <div>
          <label class="text-xs text-gray-600">Foto</label>
          <input id="incFoto" type="file" accept="image/*" capture="environment" class="w-full"/>
          <img id="incFotoPrev" class="preview mt-1"/>
        </div>
        <div>
          <label class="text-xs text-gray-600">Ubicación</label>
          <div class="flex gap-2">
            <button id="btnGPSInc" class="btn">Tomar GPS</button>
            <div id="incGPS" class="text-xs text-gray-600 self-center"></div>
          </div>
        </div>
      </div>
      <div class="mt-3 flex gap-2">
        <button id="btnGuardarIncid" class="btn">Guardar incidencia</button>
        <button id="btnExportIncid" class="btn secondary">Exportar CSV</button>
      </div>
    </div>

    <div class="card p-3">
      <h3 class="font-semibold text-sm sm:text-base" style="color:var(--ink)">Incidencias registradas (sesión)</h3>
      <div class="overflow-auto">
        <table class="w-full table min-w-[900px]">
          <thead><tr>
            <th class="text-left px-2 py-2">Fecha/Hora</th>
            <th class="text-left px-2 py-2">Pedido</th>
            <th class="text-left px-2 py-2">Tipo</th>
            <th class="text-left px-2 py-2">Lat</th><th class="text-left px-2 py-2">Lon</th><th class="text-left px-2 py-2">Prec.</th>
            <th class="text-left px-2 py-2">Descripción</th>
            <th class="text-left px-2 py-2">Foto</th>
          </tr></thead>
          <tbody id="tbodyIncid" class="text-xs sm:text-sm"></tbody>
        </table>
      </div>
    </div>
  </div>
</section>

<!-- KPIs, AUDITORÍA, CONFIG (idénticos a la versión previa) -->
<section id="secKPIs" class="section">
  <div class="max-w-7xl mx-auto p-3 sm:p-4 space-y-4">
    <div class="card p-3">
      <div class="flex flex-wrap items-center gap-2">
        <div class="flex items-center gap-2 text-xs sm:text-sm">
          <span>Empresa:</span>
          <span class="chip kpi-emp active" data-empresa="">Todas</span>
          <span class="chip kpi-emp" data-empresa="karaka">karaka</span>
          <span class="chip kpi-emp" data-empresa="distribuidora">distribuidora</span>
        </div>
        <div class="flex items-center gap-2 text-xs sm:text-sm">
          <label class="text-gray-600" for="kpiSelVendedor">Vendedor:</label>
          <select id="kpiSelVendedor" class="border border-gray-300 rounded-md px-2 py-1 bg-white"><option value="">Todos</option></select>
          <label class="text-gray-600 ml-1 sm:ml-2" for="kpiSelGestor">Gestor:</label>
          <select id="kpiSelGestor" class="border border-gray-300 rounded-md px-2 py-1 bg-white"><option value="">Todos</option></select>
          <label class="text-gray-600 ml-1 sm:ml-2" for="kpiSelProvincia">Provincia:</label>
          <select id="kpiSelProvincia" class="border border-gray-300 rounded-md px-2 py-1 bg-white"><option value="">Todas</option></select>
        </div>
        <div class="flex items-center gap-2 ml-auto">
          <input id="kpiFDesde" type="date" class="border border-gray-300 rounded-md px-2 py-1 bg-white">
          <input id="kpiFHasta" type="date" class="border border-gray-300 rounded-md px-2 py-1 bg-white">
        </div>
      </div>
    </div>
    <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
      <div class="kpi">
        <div class="text-xs sm:text-sm">Pedidos (filtrados)</div>
        <div id="kpiTotalFiltrados" class="text-xl sm:text-2xl font-semibold">—</div>
      </div>
      <div class="kpi">
        <div class="text-xs sm:text-sm">Provincias (distintas)</div>
        <div id="kpiProvDistinct" class="text-xl sm:text-2xl font-semibold">—</div>
      </div>
      <div class="kpi">
        <div class="text-xs sm:text-sm">Pedidos por Provincia</div>
        <div id="kpiProvCount" class="text-xl sm:text-2xl font-semibold">—</div>
        <div id="kpiProvName" class="text-xs text-gray-500"></div>
      </div>
    </div>
    <div class="grid md:grid-cols-3 gap-3">
      <div class="card p-3"><h3 class="font-semibold mb-2 text-sm sm:text-base" style="color:var(--ink)">Pedidos por Vendedor</h3><canvas id="kpiVendChart" height="220"></canvas></div>
      <div class="card p-3"><h3 class="font-semibold mb-2 text-sm sm:text-base" style="color:var(--ink)">Pedidos por Gestor</h3><canvas id="kpiGestChart" height="220"></canvas></div>
      <div class="card p-3"><h3 class="font-semibold mb-2 text-sm sm:text-base" style="color:var(--ink)">Pedidos por Provincia</h3><canvas id="kpiProvChart" height="220"></canvas></div>
    </div>
    <div class="grid md:grid-cols-3 gap-3">
      <div class="card p-3"><h3 class="font-semibold mb-2 text-sm sm:text-base" style="color:var(--ink)">Top Vendedores</h3><div id="kpiVendTbl" class="text-xs sm:text-sm"></div></div>
      <div class="card p-3"><h3 class="font-semibold mb-2 text-sm sm:text-base" style="color:var(--ink)">Top Gestores</h3><div id="kpiGestTbl" class="text-xs sm:text-sm"></div></div>
      <div class="card p-3"><h3 class="font-semibold mb-2 text-sm sm:text-base" style="color:var(--ink)">Top Provincias</h3><div id="kpiProvTbl" class="text-xs sm:text-sm"></div></div>
    </div>
  </div>
</section>

<section id="secAuditoria" class="section">
  <div class="max-w-7xl mx-auto p-3 sm:p-4 space-y-4">
    <div class="card p-3">
      <div class="flex items-center justify-between">
        <h3 class="font-semibold text-sm sm:text-base" style="color:var(--ink)">Bitácora</h3>
        <button id="btnExportAudit" class="btn secondary">Exportar CSV</button>
      </div>
      <div class="overflow-auto">
        <table class="w-full table min-w-[900px]">
          <thead><tr>
            <th class="text-left px-2 py-2">Fecha/Hora</th>
            <th class="text-left px-2 py-2">Usuario/Rol</th>
            <th class="text-left px-2 py-2">Acción</th>
            <th class="text-left px-2 py-2">Entidad</th>
            <th class="text-left px-2 py-2">ID</th>
            <th class="text-left px-2 py-2">Detalle</th>
          </tr></thead>
          <tbody id="tbodyAudit" class="text-xs sm:text-sm"></tbody>
        </table>
      </div>
    </div>
  </div>
</section>

<section id="secConfig" class="section">
  <div class="max-w-7xl mx-auto p-3 sm:p-4 space-y-4">
    <div class="card p-3">
      <h3 class="font-semibold text-sm sm:text-base" style="color:var(--ink)">Parámetros & Conectores</h3>
      <div class="grid md:grid-cols-3 gap-3">
        <div>
          <label class="text-xs text-gray-600">Modo de escritura</label>
          <select id="cfgWriteMode" class="w-full border border-gray-300 rounded-md px-2 py-1">
            <option value="csv">CSV local (descargar)</option>
            <option value="apps_script">Apps Script WebApp (Google Sheets)</option>
          </select>
        </div>
        <div class="md:col-span-2">
          <label class="text-xs text-gray-600">Apps Script URL (POST)</label>
          <input id="cfgAppsUrl" placeholder="https://script.google.com/macros/s/XXXXX/exec" class="w-full border border-gray-300 rounded-md px-2 py-1"/>
        </div>
      </div>
      <div class="mt-3 flex gap-2">
        <button id="btnSaveConfig" class="btn">Guardar configuración</button>
        <button id="btnPing" class="btn secondary">Probar conexión</button>
      </div>
      <div id="cfgMsg" class="debug mt-2"></div>
    </div>
  </div>
</section>

<!-- Modal Detalle -->
<div id="detailModal" class="fixed inset-0 bg-black/50 hidden z-[100]">
  <div class="max-w-3xl mx-auto bg-white rounded-xl p-4 mt-24 shadow-lg">
    <div class="flex items-center justify-between">
      <h3 class="font-semibold" style="color:var(--ink)">Detalle</h3>
      <div class="flex gap-2">
        <button id="btnCopyDetail" class="btn secondary text-xs">Copiar</button>
        <button id="btnCloseDetail" class="btn text-xs">Cerrar</button>
      </div>
    </div>
    <pre id="detailPre" class="mt-3 text-xs sm:text-sm max-h-[65vh] overflow-auto bg-gray-50 border border-gray-200 rounded p-3"></pre>
  </div>
</div>

<div id="toast" class="toast">Mensaje</div>

<script>
const CONFIG={
  sheets:{
    clientesCsvUrl:"https://docs.google.com/spreadsheets/d/e/2PACX-1vQt6FhUerc3A1eDpvKdM_KJ2yU8DTXy2MpmaRMeaORqzBxFVY70XzdAw-aL9e10V8l-hsIUKUlj5Ygn/pub?gid=193390473&single=true&output=csv",
    pedidosKarakaCsvUrl:"https://docs.google.com/spreadsheets/d/e/2PACX-1vQt6FhUerc3A1eDpvKdM_KJ2yU8DTXy2MpmaRMeaORqzBxFVY70XzdAw-aL9e10V8l-hsIUKUlj5Ygn/pub?gid=1945180719&single=true&output=csv",
    pedidosDistribuidoraCsvUrl:"https://docs.google.com/spreadsheets/d/e/2PACX-1vQt6FhUerc3A1eDpvKdM_KJ2yU8DTXy2MpmaRMeaORqzBxFVY70XzdAw-aL9e10V8l-hsIUKUlj5Ygn/pub?gid=919779363&single=true&output=csv"
  },
  write:{ mode:'csv', appsScriptUrl:'' }
};
function toast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),3500); }
const norm = s => (s??'').toString().normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase().trim();
const canon = s => norm(String(s||'').replace(/[^a-zA-Z0-9]/g,''));
function smartFloat(x){ if(x==null) return null; let s=String(x).trim(); if(!s) return null; s=s.replace(/\s+/g,''); if(/\d+\.\d+,\d+/.test(s)){ s=s.replace(/\./g,''); s=s.replace(',', '.'); } else if(/\d+,\d+\.\d+/.test(s)){ s=s.replace(/,/g,''); } else if(/^\d+,\d+$/.test(s)){ s=s.replace(',', '.'); } const n=parseFloat(s); return Number.isFinite(n)?n:null; }
function excelDateToISO(num){ const base=new Date(Date.UTC(1899,11,30)); const d=new Date(base.getTime()+num*86400000); return d.toISOString().slice(0,10); }
function dmyToISO(s){ const m=s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/); if(!m) return ''; const [_,d,mo,y]=m; return `${y}-${String(mo).padStart(2,'0')}-${String(d).padStart(2,'0')}`; }
function mdyToISO(s){ const m=s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/); if(!m) return ''; const [_,mo,d,y]=m; return `${y}-${String(mo).padStart(2,'0')}-${String(d).padStart(2,'0')}`; }
function detectAndISO(s){ const parts = s.split(/[\/\-]/); if(parts.length===3){ const [a,b,c]=parts.map(x=>parseInt(x,10)); if(!isNaN(a)&&!isNaN(b)&&!isNaN(c)){ if(a>12) return dmyToISO(s); if(b>12) return mdyToISO(s); return dmyToISO(s); } } return ''; }
function toISO(value){ if(value===null||value===undefined) return ''; const s=String(value).trim(); if(s==='') return ''; if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return s; if(/^\d{1,2}[\/\-]\d{1,2}[\/\-]\d{4}$/.test(s)) return detectAndISO(s); const num=Number(s); if(Number.isFinite(num)) return excelDateToISO(num); const d=new Date(s); if(!isNaN(d)) return d.toISOString().slice(0,10); return ''; }
async function fetchCsv(url,label){ const res=await fetch(url,{cache:'no-store'}); if(!res.ok) throw new Error(label+': HTTP '+res.status); const text=await res.text(); const parsed = Papa.parse(text,{header:true,skipEmptyLines:'greedy'}); if(parsed.errors?.length) console.warn('Papa errors', parsed.errors.slice(0,3)); return parsed.data.map(row=>{ const clean={}; for(const k in row){ const val = typeof row[k]==='string' ? row[k].replace(/\uFEFF/g,'').trim() : row[k]; clean[k.replace(/\uFEFF/g,'').trim()] = val; } return clean; }); }
function dataURL(file, cb){ const r=new FileReader(); r.onload = ()=>cb(r.result); r.readAsDataURL(file); }
function downloadCSV(filename, rows){ const csv = Papa.unparse(rows); const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'}); const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = filename; link.click(); }
async function postAppsScript(resource, record){ const url=CONFIG.write.appsScriptUrl?.trim(); if(!url){ throw new Error('Apps Script URL no configurada'); } const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ resource, record }) }); if(!res.ok) throw new Error('HTTP '+res.status); const js = await res.json().catch(()=>({ok:true})); return js; }
const COLS={
  bultos:['Bultos','BULTOS','bultos','Cajas','Unidades','Cantidad','CANTIDAD','Bult'],
  codEmpresa:[ 'Cod Empresa','Codigo','Código','CodEmpresa','cod empresa','cod_empresa' ],
  empresaHoja:['Empresa','empresa','EMPRESA'],
  nombreCliente:['RazonSocial','Razon Social','Razón Social','Cliente','Nombre','Nombre Cliente'],
  lat:['latitud','Latitud','LATITUD','lat','Lat'],
  lon:['longitud','Longitud','LONGITUD','lon','Lon','lng'],
  vendedor:['vendedor','Vendedor','VENDEDOR'],
  gestor:['gestor_servicio','GESTOR_SERVICIO','Gestor Servicio','Gestor'],
  provincia:['provincia','Provincia','PROVINCIA'],
  id:['id','ID','Id'],
  pedidoId:['PEDIDO #','Pedido','PEDIDO','Pedido #','No Pedido','Nº Pedido','N° Pedido','Pedido N°','id'],
  fecha:['FECHA','Fecha','fecha','Fecha Pedido','FECHA PEDIDO'],
  estado:['ESTADO','Estado','estado','Estatus','ESTATUS','Estatus Pedido'],
  valor:['VALOR','Valor','Total','Monto','Total Neto'],
  codEmpresaPedido:['Cod Empresa','Codigo','Código','CodEmpresa','cod empresa','cod_empresa','codempresa','Cod Cliente/Empresa','Cod Cliente - Empresa']
};
function getFirst(row, keys){ for(const k of keys){ if(row[k]!==undefined && String(row[k]).trim()!=='') return String(row[k]).trim(); } const idx={}; for(const k in row){ idx[norm(k)]=k; } for(const k of keys){ const found=idx[norm(k)]; if(found && String(row[found]).trim()!=='') return String(row[found]).trim(); } return ''; }
let state={
  clientes:[], pedidos:[], byClientKey:new Map(),
  map:null, markers:[], markerByKey:{},
  miniMap:null, miniMarkers:[],
  chartEstados:null, chartVend:null, chartGest:null, chartProv:null,
  ui:{tab:'todos', empresa:'', q:'', desde:'', hasta:'', ven:'', ges:'', prov:''},
  despachos:[], entregas:[], incidencias:[], audit:[], orderRawColumns:[],
  bultosCol:null
};
function buildClientIndex(clients){
  const index=new Map();
  clients.forEach(c=>{
    const code=String(c.codEmpresa||'').trim();
    const emp=String(c.empresa||'').trim();
    const keyCode=canon(code);
    const keyEmpCode=canon(emp+code);
    if(keyCode) index.set(keyCode,c);
    if(keyEmpCode) index.set(keyEmpCode,c);
  });
  return index;
}
function detectBultosCol(cols){
  const cand = cols.find(h=>/bult|bulto|bultos|caja|cajas|unid|cantidad/i.test(h));
  return cand||null;
}
async function loadData(){
  const [rawClientes, rawK, rawD] = await Promise.all([
    fetchCsv(CONFIG.sheets.clientesCsvUrl,'Clientes'),
    fetchCsv(CONFIG.sheets.pedidosKarakaCsvUrl,'Karaka'),
    fetchCsv(CONFIG.sheets.pedidosDistribuidoraCsvUrl,'Distribuidora')
  ]);
  const clients = rawClientes.map(c=>{
    const cod = getFirst(c, COLS.codEmpresa);
    return {
      codEmpresa: cod,
      empresa: (getFirst(c, COLS.empresaHoja)||'').toLowerCase(),
      nombre: getFirst(c, COLS.nombreCliente) || cod,
      lat: smartFloat(getFirst(c, COLS.lat)),
      lon: smartFloat(getFirst(c, COLS.lon)),
      vendedor: getFirst(c, COLS.vendedor) || '',
      gestor: getFirst(c, COLS.gestor) || '',
      provincia: getFirst(c, COLS.provincia) || '',
      id: getFirst(c, COLS.id) || ''
    };
  }).filter(c=>String(c.codEmpresa||'').trim()!==''); 
  const byKey = buildClientIndex(clients);
  state.byClientKey = byKey;
  state.clientes = clients;
  const ordersRaw = [
    ...rawK.map(p=>({ ...p, EmpresaHoja:'karaka' })),
    ...rawD.map(p=>({ ...p, EmpresaHoja:'distribuidora' }))
  ];
  state.orderRawColumns = Object.keys(ordersRaw.reduce((acc,r)=>{ for(const k in r){ acc[k]=1; } return acc; },{}));
  state.bultosCol = detectBultosCol(state.orderRawColumns);
  const orders = ordersRaw.map(p=>{
    const empresa=(p.EmpresaHoja||'').toString().toLowerCase();
    const codeRaw=getFirst(p, COLS.codEmpresaPedido) || '';
    const key1=canon(codeRaw);
    const key2=canon(empresa+codeRaw);
    const cli = byKey.get(key2) || byKey.get(key1) || null;
    const vendedor=getFirst(p, COLS.vendedor) || (cli?cli.vendedor:'') || '';
    const gestor  =getFirst(p, COLS.gestor)   || (cli?cli.gestor  :'') || '';
    const provincia = cli? (cli.provincia||'') : '';
    const valor = smartFloat(getFirst(p, COLS.valor));
    const bultos = state.bultosCol ? (smartFloat(p[state.bultosCol])||0) : 1;
    return {
      raw: p,
      id: getFirst(p, COLS.pedidoId),
      cliente: getFirst(p, COLS.nombreCliente) || (cli?cli.nombre:''),
      codEmpresa: codeRaw,
      fecha: toISO(getFirst(p, COLS.fecha)),
      estado: getFirst(p, COLS.estado),
      valor,
      bultos,
      vendedor, gestor, provincia,
      empresa,
      clientKey: cli ? (byKey.get(key2)?key2:key1) : '',
      clienteRef: cli,
      bultosNum: smartFloat(getFirst(p, COLS.bultos))||0,
      valorNum: smartFloat(getFirst(p, COLS.valor))||0
    };
  });
  state.pedidos = orders;
  populateFilters();
  computeKPIs();
  renderAll(); refreshPlanner();
  const dt = new Date();
  document.getElementById('lastUpdate').textContent = `Actualizado: ${dt.toLocaleDateString()} ${dt.toLocaleTimeString()}`;
}
// ---------- Planner (Despachos) ----------
state.plan={ sel:new Set(), map:null, markers:[], markerByKey:{} };

function planApplyFilters(){
  const emp = document.getElementById('despEmp').value || '';
  const ven = document.getElementById('despFiltroVendedor').value || '';
  const ges = document.getElementById('despFiltroGestor').value || '';
  const prov= document.getElementById('despFiltroProv').value || '';
  const q   = (document.getElementById('despQ').value||'').toLowerCase();
  return state.pedidos.filter(p=>{
    const okEmp = !emp || p.empresa===emp;
    const okVen = !ven || norm(p.vendedor)===norm(ven);
    const okGes = !ges || norm(p.gestor)===norm(ges);
    const okProv= !prov|| norm(p.provincia)===norm(prov);
    const okQ   = !q || (String(p.id||'').toLowerCase().includes(q) || (p.cliente||'').toLowerCase().includes(q) || (p.codEmpresa||'').toLowerCase().includes(q));
    return okEmp && okVen && okGes && okProv && okQ;
  });
}

function planRenderList(){
  const tb=document.getElementById('tbodyPlanSel'); if(!tb) return; tb.innerHTML='';
  const rows=planApplyFilters();
  rows.forEach(p=>{
    const checked = state.plan.sel.has(p.id) ? 'checked' : '';
    const tr=document.createElement('tr');
    tr.innerHTML=`<td class="px-2 py-2"><input type="checkbox" data-pid="${p.id}" ${checked}></td>
      <td class="px-2 py-2">${p.id||''}</td>
      <td class="px-2 py-2">${p.cliente||''}</td>
      <td class="px-2 py-2">${p.provincia||''}</td>
      <td class="px-2 py-2"><span class="badge">${p.empresa||''}</span></td>
      <td class="px-2 py-2 text-right">${p.bultosNum||0}</td>
      <td class="px-2 py-2 text-right">${p.valorNum? p.valorNum.toLocaleString(): 0}</td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('input[type=checkbox][data-pid]').forEach(ch=>ch.addEventListener('change',e=>{
    const pid=e.currentTarget.getAttribute('data-pid');
    if(e.currentTarget.checked) state.plan.sel.add(pid); else state.plan.sel.delete(pid);
    planRenderTotals();
  }));
  planRenderTotals();
}


function planRenderTotals(){
  const rows=state.pedidos.filter(p=>state.plan.sel.has(p.id));
  const bultos = rows.reduce((a,b)=>a+(b.bultosNum||0),0);
  const valor  = rows.reduce((a,b)=>a+(b.valorNum||0),0);
  const provs  = [...new Set(rows.map(r=>r.provincia).filter(Boolean))].join(', ');
  const el=document.getElementById('planTotals'); 
  if(el) el.textContent=`Seleccionados: ${rows.length} • Bultos:${bultos} • Valor:${valor.toLocaleString()} • Provincias: ${provs||'—'}`;
  const pSel=document.getElementById('pillSelected'); if(pSel) pSel.textContent=rows.length;
  const pBul=document.getElementById('pillBultos'); if(pBul) pBul.textContent=bultos;
  const pVal=document.getElementById('pillValor'); if(pVal) pVal.textContent=valor.toLocaleString();
}
function planRenderMap(){
  planInitMap();
  state.plan.markers.forEach(m=>m.remove()); 
  state.plan.markers=[]; 
  state.plan.markerByKey={};
  const rows=planApplyFilters();
  let ok=0, no=0;
  const used = rows.map(p=>p.clientKey).filter(Boolean);
  const set = new Set(used);
  for(const key of set){
    const cli = state.byClientKey.get(key);
    if(!cli){ no++; continue; }
    if(cli.lat==null || cli.lon==null){ no++; continue; }
    const m=L.circleMarker([cli.lat,cli.lon],{radius:6, weight:1});
    m.addTo(state.plan.map).bindPopup(`<b>${cli.nombre||''}</b><br/>Prov: ${cli.provincia||''}`);
    state.plan.markers.push(m); 
    state.plan.markerByKey[key]=m; 
    ok++;
  }
  const info=document.getElementById('despMapInfo'); 
  if(info) info.textContent = `Pedidos filtrados: ${rows.length} • Pines: ${ok} • Sin geo: ${no}`;
  const pF=document.getElementById('pillFiltered'); if(pF) pF.textContent=rows.length;
  const pPins=document.getElementById('pillPins'); if(pPins) pPins.textContent=ok;
}
function planRenderResumen(){
  const tb=document.getElementById('tbodyPlanResumen'); if(!tb) return; tb.innerHTML='';
  const rows=planApplyFilters();
  const agg={};
  rows.forEach(p=>{
    const k=p.provincia||'N/D';
    if(!agg[k]) agg[k]={pedidos:0,bultos:0,valor:0};
    agg[k].pedidos++; agg[k].bultos+= (p.bultosNum||0); agg[k].valor+= (p.valorNum||0);
  });
  Object.entries(agg).sort((a,b)=>b[1].pedidos-a[1].pedidos).forEach(([prov,a])=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td class="px-2 py-1">${prov}</td>
      <td class="px-2 py-1 text-right">${a.pedidos}</td>
      <td class="px-2 py-1 text-right">${a.bultos}</td>
      <td class="px-2 py-1 text-right">${a.valor.toLocaleString()}</td>`;
    tb.appendChild(tr);
  });
}

function refreshPlanner(){
  const vs=uniqueNormalized(state.pedidos.map(p=>p.vendedor).filter(Boolean));
  const gs=uniqueNormalized(state.pedidos.map(p=>p.gestor).filter(Boolean));
  const ps=uniqueNormalized(state.pedidos.map(p=>p.provincia).filter(Boolean));
  const selV=document.getElementById('despFiltroVendedor');
  const selG=document.getElementById('despFiltroGestor');
  const selP=document.getElementById('despFiltroProv');
  if(selV && selV.options.length<=1){ vs.forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; selV.appendChild(o); }); }
  if(selG && selG.options.length<=1){ gs.forEach(g=>{ const o=document.createElement('option'); o.value=g; o.textContent=g; selG.appendChild(o); }); }
  if(selP && selP.options.length<=1){ ps.forEach(pv=>{ const o=document.createElement('option'); o.value=pv; o.textContent=pv; selP.appendChild(o); }); }
  const dl=document.getElementById('dlChoferes');
  if(dl && !dl.children.length){ gs.forEach(g=>{ const o=document.createElement('option'); o.value=g; dl.appendChild(o); }); }

  planRenderList(); planRenderMap(); planRenderResumen();
}

function bindPlannerUI(){
  ['despEmp','despFiltroVendedor','despFiltroGestor','despFiltroProv','despQ'].forEach(id=>{
    const el=document.getElementById(id); if(el){ el.addEventListener('input', ()=>{ planRenderList(); planRenderMap(); planRenderResumen(); }); el.addEventListener('change', ()=>{ planRenderList(); planRenderMap(); planRenderResumen(); }); }
  });
  const chkAll=document.getElementById('chkPlanAll');
  if(chkAll){ chkAll.addEventListener('change',()=>{
    if(chkAll.checked){ planApplyFilters().forEach(p=>state.plan.sel.add(p.id)); }
    else { state.plan.sel.clear(); }
    planRenderList();
  });}
  const bSelAll=document.getElementById('btnPlanSelectAll');
  if(bSelAll){ bSelAll.addEventListener('click',()=>{ planApplyFilters().forEach(p=>state.plan.sel.add(p.id)); planRenderList(); }); }
  const bClear=document.getElementById('btnPlanClear');
  if(bClear){ bClear.addEventListener('click',()=>{ state.plan.sel.clear(); planRenderList(); }); }
}

function computeKPIs(){
  const today=new Date().toISOString().slice(0,10);
  const pend=state.pedidos.filter(p=>norm(p.estado).includes('pend')).length;
  const ruta=state.pedidos.filter(p=>norm(p.estado).includes('ruta')).length;
  const entr=state.pedidos.filter(p=>/final|entreg/.test(norm(p.estado))).length;
  const hoy=state.pedidos.filter(p=>p.fecha===today).length;
  document.getElementById('kpiPendientes').textContent=pend;
  document.getElementById('kpiRuta').textContent=ruta;
  document.getElementById('kpiEntregados').textContent=entr;
  document.getElementById('kpiHoy').textContent=hoy;
}
function uniqueNormalized(values){
  const map=new Map();
  for(const v of values){
    const t=String(v||'').trim();
    if(!t) continue;
    const key=norm(t);
    if(!map.has(key)) map.set(key, t);
  }
  return [...map.values()].sort((a,b)=>a.localeCompare(b));
}
function populateFilters(){
  const selV=document.getElementById('selVendedor');
  const selG=document.getElementById('selGestor');
  const selP=document.getElementById('selProvincia');
  if(selV) selV.innerHTML='<option value="">Todos</option>';
  if(selG) selG.innerHTML='<option value="">Todos</option>';
  if(selP) selP.innerHTML='<option value="">Todas</option>';
  const vs=uniqueNormalized(state.pedidos.map(p=>p.vendedor).filter(Boolean));
  const gs=uniqueNormalized(state.pedidos.map(p=>p.gestor).filter(Boolean));
  const ps=uniqueNormalized(state.pedidos.map(p=>p.provincia).filter(Boolean));
  const countV={}, countG={};
  state.pedidos.forEach(p=>{ if(p.vendedor){ countV[norm(p.vendedor)]=(countV[norm(p.vendedor)]||0)+1; } });
  state.pedidos.forEach(p=>{ if(p.gestor){   countG[norm(p.gestor)]  =(countG[norm(p.gestor)]  ||0)+1; } });
  if(selV){ vs.forEach(v=>{ const key=norm(v); const o=document.createElement('option'); o.value=v; o.textContent=`${v} (${countV[key]||0})`; selV.appendChild(o); }); selV.value=state.ui.ven||''; }
  if(selG){ gs.forEach(g=>{ const key=norm(g); const o=document.createElement('option'); o.value=g; o.textContent=`${g} (${countG[key]||0})`; selG.appendChild(o); }); selG.value=state.ui.ges||''; }
  if(selP){ ps.forEach(pv=>{ const o=document.createElement('option'); o.value=pv; o.textContent=pv; selP.appendChild(o); }); selP.value=state.ui.prov||''; }
  // KPIs selects
  const kV=document.getElementById('kpiSelVendedor');
  const kG=document.getElementById('kpiSelGestor');
  const kP=document.getElementById('kpiSelProvincia');
  if(kV){ kV.innerHTML='<option value=\"\">Todos</option>'; vs.forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; kV.appendChild(o); }); kV.value=state.ui.ven||''; }
  if(kG){ kG.innerHTML='<option value=\"\">Todos</option>'; gs.forEach(g=>{ const o=document.createElement('option'); o.value=g; o.textContent=g; kG.appendChild(o); }); kG.value=state.ui.ges||''; }
  if(kP){ kP.innerHTML='<option value=\"\">Todas</option>'; ps.forEach(pvv=>{ const o=document.createElement('option'); o.value=pvv; o.textContent=pvv; kP.appendChild(o); }); kP.value=state.ui.prov||''; }

  // Despachos filters & selects
  const dpV=document.getElementById('dpSelVendedor');
  const dpG=document.getElementById('dpSelGestor');
  const dpP=document.getElementById('dpSelProvincia');
  const despGest=document.getElementById('despGestor');
  if(dpV){ dpV.innerHTML='<option value="">Todos</option>'; vs.forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; dpV.appendChild(o); }); }
  if(dpG){ dpG.innerHTML='<option value="">Todos</option>'; gs.forEach(g=>{ const o=document.createElement('option'); o.value=g; o.textContent=g; dpG.appendChild(o); }); }
  if(dpP){ dpP.innerHTML='<option value="">Todas</option>'; ps.forEach(pvv=>{ const o=document.createElement('option'); o.value=pvv; o.textContent=pvv; dpP.appendChild(o); }); }
  if(despGest){ despGest.innerHTML='<option value="">Seleccione</option>'; gs.forEach(g=>{ const o=document.createElement('option'); o.value=g; o.textContent=g; despGest.appendChild(o); }); }

  buildDespPedidosList(); // inicial
}
function applyFilters(rows){
  const ui = state.ui;
  return rows.filter(p=>{
    const e=(p.estado||'').toLowerCase();
    let okTab=true;
    if(ui.tab==='pendientes') okTab=e.includes('pend');
    else if(ui.tab==='facturados') okTab=e.includes('fact');
    else if(ui.tab==='entregados') okTab=/final|entreg/.test(e);
    const okEmp = !ui.empresa || p.empresa===ui.empresa;
    const q = (ui.q||'').toLowerCase();
    const okQ = !q || (String(p.id||'').toLowerCase().includes(q) ||
                       (p.cliente||'').toLowerCase().includes(q) ||
                       e.includes(q) ||
                       (p.codEmpresa||'').toLowerCase().includes(q));
    const okDesde = !ui.desde || (p.fecha && p.fecha>=ui.desde);
    const okHasta = !ui.hasta || (p.fecha && p.fecha<=ui.hasta);
    const okVen = !ui.ven || (norm(p.vendedor)===norm(ui.ven));
    const okGes = !ui.ges || (norm(p.gestor)===norm(ui.ges));
    const okProv = !ui.prov || (norm(p.provincia)===norm(ui.prov));
    return okTab && okEmp && okQ && okDesde && okHasta && okVen && okGes && okProv;
  });
}
function filterForPlanner(){
  const v = document.getElementById('dpSelVendedor')?.value || '';
  const g = document.getElementById('dpSelGestor')?.value || '';
  const p = document.getElementById('dpSelProvincia')?.value || '';
  const f = document.getElementById('dpFechaPedido')?.value || '';
  return state.pedidos.filter(o=>{
    const okV = !v || norm(o.vendedor)===norm(v);
    const okG = !g || norm(o.gestor)===norm(g);
    const okP = !p || norm(o.provincia)===norm(p);
    const okF = !f || (o.fecha && o.fecha===f);
    return okV && okG && okP && okF;
  });
}
function buildDespPedidosList(){
  const cont=document.getElementById('despPedidos'); if(!cont) return;
  const list=filterForPlanner();
  cont.innerHTML='';
  list.forEach(p=>{
    const label = `${p.id || '[sin id]'} — ${p.cliente || ''} — ${p.empresa || ''} — ${p.provincia||''}`;
    const el=document.createElement('label'); el.className='block text-xs sm:text-sm';
    el.innerHTML=`<input type="checkbox" data-pid="${p.id||''}" class="mr-1">${label}`;
    cont.appendChild(el);
  });
  updateMiniMap();
  updatePlannerSummary();
}
function updateMiniMap(){
  if(!document.getElementById('miniMap')) return;
  if(!state.miniMap){
    state.miniMap = L.map('miniMap').setView([18.5,-69.9],8);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap'}).addTo(state.miniMap);
  }else{
    setTimeout(()=>state.miniMap.invalidateSize(),150);
  }
  state.miniMarkers.forEach(m=>m.remove()); state.miniMarkers=[];
  const list=filterForPlanner();
  const bounds=[];
  list.forEach(p=>{
    const c = p.clienteRef;
    if(!c || c.lat==null || c.lon==null) return;
    const m = L.circleMarker([c.lat,c.lon],{radius:6,weight:1,color:'#2563eb',fillOpacity:.7})
      .bindPopup(`<b>${p.cliente||''}</b><br/>Prov: ${p.provincia||''}<br/>Pedido: ${p.id}`)
      .addTo(state.miniMap);
    state.miniMarkers.push(m); bounds.push([c.lat,c.lon]);
  });
  document.getElementById('dpInfo').textContent = `Pedidos visibles: ${list.length} • Pines: ${bounds.length}`;
  if(bounds.length){ state.miniMap.fitBounds(bounds, {padding:[20,20]}); }
}
function updatePlannerSummary(){
  const cont = document.getElementById('dpResumen'); if(!cont) return;
  const checks=[...document.querySelectorAll('#despPedidos input[type=checkbox]:checked')];
  const setSel = new Set(checks.map(ch=>ch.getAttribute('data-pid')));
  const base = checks.length ? state.pedidos.filter(p=>setSel.has(String(p.id))) : filterForPlanner();
  const sumByProv = {};
  base.forEach(p=>{
    const k = p.provincia || 'N/D';
    if(!sumByProv[k]) sumByProv[k] = { bultos:0, monto:0, pedidos:0 };
    sumByProv[k].bultos += (p.bultos||0);
    sumByProv[k].monto  += (p.valor||0);
    sumByProv[k].pedidos += 1;
  });
  const rows = Object.entries(sumByProv).sort((a,b)=>b[1].pedidos-a[1].pedidos);
  const tbl = document.createElement('table'); tbl.className='w-full table min-w-[500px]';
  tbl.innerHTML='<thead><tr><th class="text-left px-2 py-2">Provincia</th><th class="text-right px-2 py-2">Pedidos</th><th class="text-right px-2 py-2">Bultos</th><th class="text-right px-2 py-2">Monto</th></tr></thead>';
  const tb = document.createElement('tbody');
  rows.forEach(([prov,agg])=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td class="px-2 py-1">${prov}</td><td class="px-2 py-1 text-right">${agg.pedidos}</td><td class="px-2 py-1 text-right">${agg.bultos.toLocaleString()}</td><td class="px-2 py-1 text-right">${agg.monto.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}</td>`;
    tb.appendChild(tr);
  });
  const tot = rows.reduce((acc,[_p,a])=>{acc.ped+=a.pedidos;acc.bul+=a.bultos;acc.mon+=a.monto;return acc;},{ped:0,bul:0,mon:0});
  const trT=document.createElement('tr'); trT.innerHTML=`<td class="px-2 py-2 font-semibold">Total</td><td class="px-2 py-2 text-right font-semibold">${tot.ped}</td><td class="px-2 py-2 text-right font-semibold">${tot.bul.toLocaleString()}</td><td class="px-2 py-2 text-right font-semibold">${tot.mon.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}</td>`;
  tb.appendChild(trT);
  tbl.appendChild(tb);
  cont.innerHTML=''; cont.appendChild(tbl);
}
function renderTable(){
  const tbody=document.getElementById('tbody'); tbody.innerHTML='';
  const thead=document.getElementById('theadPedidos'); if(thead) thead.innerHTML='';
  state.ui.q=(document.getElementById('q').value||'').trim();
  state.ui.desde=document.getElementById('fDesde').value||'';
  state.ui.hasta=document.getElementById('fHasta').value||'';
  state.ui.ven=document.getElementById('selVendedor').value||'';
  state.ui.ges=document.getElementById('selGestor').value||'';
  state.ui.prov=document.getElementById('selProvincia').value||'';
  const data=applyFilters(state.pedidos);

  const fixedHeads=['Pedido','Cliente','Cod Empresa','Fecha','Estado','Empresa','Vendedor','Gestor','Provincia','Valor','Bultos','Acciones'];
  const trh=document.createElement('tr');
  fixedHeads.forEach(h=>{ const th=document.createElement('th'); th.className='text-left px-2 sm:px-3 py-2'; th.textContent=h; trh.appendChild(th); });
  const rawCols=state.orderRawColumns||[];
  const skipSet=new Set(['EmpresaHoja']); // raw column mostradas solo si no son duplicadas
  rawCols.forEach(h=>{ if(skipSet.has(h)) return; if(fixedHeads.map(x=>x.toLowerCase()).includes(h.toLowerCase())) return; const th=document.createElement('th'); th.className='text-left px-2 sm:px-3 py-2'; th.textContent=h; trh.appendChild(th); });
  if(thead) thead.appendChild(trh);

  for(const p of data){
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td class="px-2 sm:px-3 py-2">${p.id||''}</td>
      <td class="px-2 sm:px-3 py-2">${p.cliente||''}</td>
      <td class="px-2 sm:px-3 py-2">${p.codEmpresa||''}</td>
      <td class="px-2 sm:px-3 py-2">${p.fecha||''}</td>
      <td class="px-2 sm:px-3 py-2">${p.estado||''}</td>
      <td class="px-2 sm:px-3 py-2"><span class="badge">${p.empresa||''}</span></td>
      <td class="px-2 sm:px-3 py-2">${p.vendedor||''}</td>
      <td class="px-2 sm:px-3 py-2">${p.gestor||''}</td>
      <td class="px-2 sm:px-3 py-2">${p.provincia||''}</td>
      <td class="px-2 sm:px-3 py-2">${(p.valor??'').toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}</td>
      <td class="px-2 sm:px-3 py-2">${p.bultos??''}</td>
      <td class="px-2 sm:px-3 py-2"><button class="btn text-xs sm:text-sm" data-key="${p.clientKey}">Ver</button></td>`;
    const frag=document.createDocumentFragment();
    (state.orderRawColumns||[]).forEach(col=>{
      if(['EmpresaHoja'].includes(col)) return;
      if(fixedHeads.map(x=>x.toLowerCase()).includes(col.toLowerCase())) return;
      const td=document.createElement('td'); td.className='px-2 sm:px-3 py-2';
      td.textContent = (p.raw && (p.raw[col]!==undefined && p.raw[col]!==null)) ? String(p.raw[col]) : '';
      frag.appendChild(td);
    });
    tr.appendChild(frag);
    tbody.appendChild(tr);
  }
  tbody.querySelectorAll('button[data-key]').forEach(b=>b.addEventListener('click',e=>{
    const key=e.currentTarget.getAttribute('data-key');
    focusMarkerByKey(key);
  }));
  const miss=data.filter(p=>!p.clientKey || !p.clienteRef).slice(0,10);
  const mism=document.getElementById('mismatch');
  mism.innerHTML = miss.length ? `<b>Pedidos sin cliente enlazado (muestra 10):</b><br/>${miss.map(p=>`• Pedido ${p.id||'(sin id)'} — Empresa:${p.empresa} — Código:"${p.codEmpresa}"`).join('<br/>')}` : '';
}
function initMap(){ state.map=L.map('map').setView([18.5,-69.9],8);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap'}).addTo(state.map);
}
function renderMap(){
  state.markers.forEach(m=>m.remove()); state.markers=[]; state.markerByKey={};
  const filtered=applyFilters(state.pedidos);
  const used = filtered.map(p=>p.clientKey).filter(Boolean);
  const usedSet = new Set(used);
  let ok=0, noGeo=0, noClient=0, sinKey=filtered.length - used.length;
  for(const key of usedSet){
    const c = state.byClientKey.get(key);
    if(!c){ noClient++; continue; }
    if(c.lat==null || c.lon==null){ noGeo++; continue; }
    const m=L.marker([c.lat,c.lon]).addTo(state.map);
    m.bindPopup(`<b>${c.nombre||''}</b><br/>Cod Empresa: ${c.codEmpresa}${c.vendedor?'<br/>Vendedor: '+c.vendedor:''}${c.gestor?'<br/>Gestor: '+c.gestor:''}${c.provincia?'<br/>Provincia: '+c.provincia:''}`);
    state.markers.push(m); state.markerByKey[key]=m; ok++;
  }
  document.getElementById('debugText').textContent=`Filtrados:${filtered.length} • Con clave:${used.length} • Sin clave:${sinKey} • Pines:${ok} • Sin coord:${noGeo} • Sin cliente:${noClient}`;
}
function focusMarkerByKey(key){ const m=state.markerByKey[key]; if(m){ state.map.setView(m.getLatLng(),14); m.openPopup(); } else toast('No hay pin para este registro.'); }
function renderChartEstados(){
  const ctx=document.getElementById('chartEstados');
  const filtered=applyFilters(state.pedidos); const countBy={};
  filtered.forEach(p=>{ const e=p.estado||'N/D'; countBy[e]=(countBy[e]||0)+1; });
  const pairs=Object.entries(countBy).sort((a,b)=>b[1]-a[1]).slice(0,6);
  const labels=pairs.map(p=>p[0]); const data=pairs.map(p=>p[1]);
  if(state.chartEstados) state.chartEstados.destroy();
  state.chartEstados=new Chart(ctx,{type:'bar',data:{labels,datasets:[{label:'Pedidos',data}]},options:{plugins:{legend:{display:false}}}});
}
function createUUID(){ return 'r'+Math.random().toString(36).slice(2,9); }
function buildDespachosList(){
  const tb=document.getElementById('tbodyDespachos'); tb.innerHTML='';
  state.despachos.forEach(r=>{
    const tr=document.createElement('tr');
    const provs = [...new Set(r.pedidos.map(id=>{
      const p = state.pedidos.find(x=>String(x.id)===String(id));
      return p ? (p.provincia||'') : '';
    }).filter(Boolean))].join(', ');
    const totB = r.pedidos.reduce((s,id)=>{ const p=state.pedidos.find(x=>String(x.id)===String(id)); return s + (p?.bultos||0); },0);
    const totM = r.pedidos.reduce((s,id)=>{ const p=state.pedidos.find(x=>String(x.id)===String(id)); return s + (p?.valor||0); },0);
    tr.innerHTML=`<td class="px-2 py-2">${r.fecha}</td>
      <td class="px-2 py-2">${r.ruta_id}</td>
      <td class="px-2 py-2">${r.gestor}</td>
      <td class="px-2 py-2">${r.chofer||''}</td>
      <td class="px-2 py-2">${r.vehiculo||''}</td>
      <td class="px-2 py-2">${r.ventana||''}</td>
      <td class="px-2 py-2">${provs||''}</td>
      <td class="px-2 py-2 text-right">${r.pedidos.length}</td>
      <td class="px-2 py-2 text-right">${totB.toLocaleString()}</td>
      <td class="px-2 py-2 text-right">${totM.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}</td>
      <td class="px-2 py-2"><span class="badge">${r.estado_ruta}</span></td>
      <td class="px-2 py-2">
        <button class="btn secondary text-xs" data-act="ver" data-rid="${r.ruta_id}">Ver</button>
        <button class="btn warn text-xs" data-act="ruta" data-rid="${r.ruta_id}">En ruta</button>
        <button class="btn text-xs" data-act="fin" data-rid="${r.ruta_id}">Finalizar</button>
        <button class="btn danger text-xs" data-act="can" data-rid="${r.ruta_id}">Cancelar</button>
      </td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('button[data-act]').forEach(b=>b.addEventListener('click',e=>{
    const id=e.currentTarget.getAttribute('data-rid');
    const act=e.currentTarget.getAttribute('data-act');
    const r = state.despachos.find(x=>x.ruta_id===id);
    if(!r) return;
    if(act==='ruta'){ r.estado_ruta='En ruta'; addAudit('planner','update','ruta',id,{estado:'En ruta'}); buildDespachosList(); }
    if(act==='fin'){ r.estado_ruta='Finalizado'; addAudit('planner','update','ruta',id,{estado:'Finalizado'}); buildDespachosList(); }
    if(act==='can'){ r.estado_ruta='Cancelado'; addAudit('planner','update','ruta',id,{estado:'Cancelado'}); buildDespachosList(); }
    if(act==='ver'){
      // centra mini mapa a pedidos de la ruta
      if(!state.miniMap) return;
      const bounds=[];
      r.pedidos.forEach(pid=>{
        const p = state.pedidos.find(x=>String(x.id)===String(pid));
        const c = p?.clienteRef;
        if(c?.lat!=null && c?.lon!=null) bounds.push([c.lat,c.lon]);
      });
      if(bounds.length){ state.miniMap.fitBounds(bounds,{padding:[20,20]}); }
    }
  }));
}
function canvasToDataURL(canvas){ return canvas.toDataURL('image/png'); }
function clearCanvas(canvas){ const ctx=canvas.getContext('2d'); ctx.clearRect(0,0,canvas.width,canvas.height); }
function renderEntregasTable(){
  const tb=document.getElementById('tbodyEntregas'); tb.innerHTML='';
  state.entregas.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td class="px-2 py-2">${r.fecha_hora}</td>
      <td class="px-2 py-2">${r.pedido_id}</td>
      <td class="px-2 py-2">${r.cliente||''}</td>
      <td class="px-2 py-2">${r.gestor||''}</td>
      <td class="px-2 py-2">${r.estado_entrega}</td>
      <td class="px-2 py-2">${r.lat||''}</td>
      <td class="px-2 py-2">${r.lon||''}</td>
      <td class="px-2 py-2">${r.accuracy||''}</td>
      <td class="px-2 py-2">${r.observaciones||''}</td>
      <td class="px-2 py-2">${r.foto_url?'<a class="link" href="'+r.foto_url+'" target="_blank">Ver</a>':''}</td>
      <td class="px-2 py-2">${r.firma_url?'<a class="link" href="'+r.firma_url+'" target="_blank">Ver</a>':''}</td>`;
    tb.appendChild(tr);
  });
}
function openRouteModal(route){
  document.getElementById('routeModal').classList.remove('hidden');
  document.getElementById('routeInfo').innerHTML = `
    <div><b>Fecha:</b> ${route.fecha}</div>
    <div><b>Ruta ID:</b> ${route.ruta_id}</div>
    <div><b>Gestor:</b> ${route.gestor} — <b>Chofer:</b> ${route.chofer} — <b>Vehículo:</b> ${route.vehiculo}</div>
    <div><b>Ventana:</b> ${route.ventana}</div>
    <div><b>Empresas:</b> ${(route.empresas||[]).join(', ')}</div>
    <div><b>Provincias:</b> ${(route.provincias||[]).join(', ')}</div>
    <div><b>Pedidos:</b> ${route.pedidos.length} — <b>Bultos:</b> ${route.bultos} — <b>Valor:</b> ${route.valor.toLocaleString()}</div>
  `;
  const tb=document.getElementById('tbodyRouteDetail'); tb.innerHTML='';
  (route.detalle||[]).forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td class="px-2 py-1">${r.pedido}</td>
      <td class="px-2 py-1">${r.cliente}</td>
      <td class="px-2 py-1">${r.provincia}</td>
      <td class="px-2 py-1 text-right">${r.bultos}</td>
      <td class="px-2 py-1 text-right">${(r.valor||0).toLocaleString()}</td>`;
    tb.appendChild(tr);
  });
  const mapEl=document.getElementById('mapRoute');
  if(mapEl._l360map){ mapEl._l360map.remove(); mapEl._l360map=null; }
  const map=L.map('mapRoute').setView([18.5,-69.9],8);
  mapEl._l360map=map;
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
  const orderObjs = state.pedidos.filter(p=>route.pedidos.includes(p.id));
  const setKeys = new Set(orderObjs.map(o=>o.clientKey).filter(Boolean));
  setKeys.forEach(k=>{
    const c=state.byClientKey.get(k);
    if(c && c.lat!=null && c.lon!=null){
      L.marker([c.lat,c.lon]).addTo(map).bindPopup(`<b>${c.nombre}</b><br/>${c.provincia||''}`);
    }
  });
}
document.getElementById('btnCloseRoute')?.addEventListener('click', ()=>{
  document.getElementById('routeModal').classList.add('hidden');
});
function renderIncidTable(){
  const tb=document.getElementById('tbodyIncid'); tb.innerHTML='';
  state.incidencias.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td class="px-2 py-2">${r.fecha_hora}</td>
      <td class="px-2 py-2">${r.pedido_id}</td>
      <td class="px-2 py-2">${r.tipo}</td>
      <td class="px-2 py-2">${r.lat||''}</td>
      <td class="px-2 py-2">${r.lon||''}</td>
      <td class="px-2 py-2">${r.accuracy||''}</td>
      <td class="px-2 py-2">${r.descripcion||''}</td>
      <td class="px-2 py-2">${r.foto_url?'<a class="link" href="'+r.foto_url+'" target="_blank">Ver</a>':''}</td>`;
    tb.appendChild(tr);
  });
}
function aggCountBy(list, key){ const m={}; list.forEach(x=>{ const v=norm(x[key]); if(!v) return; m[v]=(m[v]||0)+1; }); return m; }
function renderKPIs(){
  const data=applyFilters(state.pedidos);
  const total = data.length;
  const provSet = new Set(data.map(p=>norm(p.provincia)).filter(Boolean));
  const selProv = state.ui.prov || '';
  let provName = selProv;
  let provCount = 0;
  const provCounts = aggCountBy(data,'provincia');
  if(!provName){
    const top = Object.entries(provCounts).sort((a,b)=>b[1]-a[1])[0];
    provName = top ? top[0] : '';
  }
  if(provName){
    provCount = data.filter(p=>norm(p.provincia)===norm(provName)).length;
  }
  document.getElementById('kpiTotalFiltrados').textContent = total;
  document.getElementById('kpiProvDistinct').textContent = provSet.size;
  document.getElementById('kpiProvCount').textContent = provCount || 0;
  document.getElementById('kpiProvName').textContent = provName || '—';

  const vend=aggCountBy(data,'vendedor'); const gest=aggCountBy(data,'gestor'); const prov=aggCountBy(data,'provincia');
  function topPairs(obj){ return Object.entries(obj).map(([k,v])=>[k,v]).sort((a,b)=>b[1]-a[1]).slice(0,10); }
  function buildChart(canvasId, pairs, label){
    const labels=pairs.map(p=>p[0]); const values=pairs.map(p=>p[1]);
    if(canvasId==='kpiVendChart' && state.chartVend){ state.chartVend.destroy(); }
    if(canvasId==='kpiGestChart' && state.chartGest){ state.chartGest.destroy(); }
    if(canvasId==='kpiProvChart' && state.chartProv){ state.chartProv.destroy(); }
    const ctx=document.getElementById(canvasId);
    const chart=new Chart(ctx,{type:'bar',data:{labels,datasets:[{label, data:values}]},options:{plugins:{legend:{display:false}}}});
    if(canvasId==='kpiVendChart') state.chartVend=chart;
    if(canvasId==='kpiGestChart') state.chartGest=chart;
    if(canvasId==='kpiProvChart') state.chartProv=chart;
  }
  buildChart('kpiVendChart', topPairs(vend), 'Pedidos');
  buildChart('kpiGestChart', topPairs(gest), 'Pedidos');
  buildChart('kpiProvChart', topPairs(prov), 'Pedidos');
  function buildTable(divId, pairs){
    const div=document.getElementById(divId); div.innerHTML='';
    const tbl=document.createElement('table'); tbl.className='w-full';
    tbl.innerHTML='<thead><tr><th class="text-left text-xs py-1">Nombre</th><th class="text-right text-xs py-1">Pedidos</th></tr></thead>';
    const tb=document.createElement('tbody');
    pairs.forEach(p=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td class="text-xs py-1">${p[0]}</td><td class="text-xs py-1 text-right">${p[1]}</td>`; tb.appendChild(tr); });
    tbl.appendChild(tb); div.appendChild(tbl);
  }
  function topPairs(obj){ return Object.entries(obj).sort((a,b)=>b[1]-a[1]).slice(0,10); }
  buildTable('kpiVendTbl', topPairs(vend));
  buildTable('kpiGestTbl', topPairs(gest));
  buildTable('kpiProvTbl', topPairs(prov));
}
function addAudit(user, action, entity, id, detail){
  const rec={ 
    fecha_hora:new Date().toISOString(), 
    user, action, entity, id, 
    detail: detail || {}
  };
  state.audit.unshift(rec);
  const tb=document.getElementById('tbodyAudit');
  if(tb){
    const tr=document.createElement('tr');
    const encoded = encodeURIComponent(JSON.stringify(rec.detail));
    tr.innerHTML=`<td class="px-2 py-2">${rec.fecha_hora}</td>
      <td class="px-2 py-2">${rec.user}</td>
      <td class="px-2 py-2">${rec.action}</td>
      <td class="px-2 py-2">${rec.entity}</td>
      <td class="px-2 py-2">${rec.id}</td>
      <td class="px-2 py-2"><button class="btn secondary text-xs" data-detail="${encoded}">Ver</button></td>`;
    tb.prepend(tr);
    const btn = tr.querySelector('button[data-detail]');
    if(btn){
      btn.addEventListener('click', ()=>{
        try{
          const raw = decodeURIComponent(btn.getAttribute('data-detail'));
          const obj = JSON.parse(raw);
          openDetailModal(obj);
        }catch(e){
          openDetailModal({error: 'No se pudo parsear el detalle', original: btn.getAttribute('data-detail')});
        }
      });
    }
  }
}
function openDetailModal(obj){
  const pre = document.getElementById('detailPre');
  pre.textContent = JSON.stringify(obj, null, 2);
  document.getElementById('detailModal').classList.remove('hidden');
}
function closeDetailModal(){ document.getElementById('detailModal').classList.add('hidden'); }
function renderAll(){ renderTable(); renderMap(); renderChartEstados(); renderKPIs(); buildDespPedidosList(); buildDespachosList(); }
function bindPedidosUI(){
  document.querySelectorAll('#secPedidos .tab[data-tab]').forEach(el=>el.addEventListener('click',()=>{
    document.querySelectorAll('#secPedidos .tab[data-tab]').forEach(t=>t.classList.remove('active'));
    el.classList.add('active'); state.ui.tab=el.dataset.tab; renderAll(); refreshPlanner();
  }));
  document.querySelectorAll('#secPedidos .chip').forEach(el=>el.addEventListener('click',()=>{
    document.querySelectorAll('#secPedidos .chip').forEach(t=>t.classList.remove('active'));
    el.classList.add('active'); state.ui.empresa=el.dataset.empresa||''; renderAll(); refreshPlanner();
  }));
  ['q','fDesde','fHasta','selVendedor','selGestor','selProvincia'].forEach(id=>{
    const el=document.getElementById(id);
    el.addEventListener('input',renderAll);
    el.addEventListener('change',renderAll);
  });
  document.getElementById('toggleTable').addEventListener('click',()=>{
    const wrap=document.getElementById('tableWrap');
    if(wrap.style.display==='none'){ wrap.style.display='block'; event.target.textContent='Ocultar tabla'; }
    else { wrap.style.display='none'; event.target.textContent='Mostrar tabla'; }
  });
  document.getElementById('toggleMap').addEventListener('click',()=>{
    const wrap=document.getElementById('mapWrap');
    if(wrap.style.display==='none'){ wrap.style.display='block'; event.target.textContent='Ocultar mapa'; setTimeout(()=>state.map.invalidateSize(),200); }
    else { wrap.style.display='none'; event.target.textContent='Mostrar mapa'; }
  });
}
function bindKPIs(){
  document.querySelectorAll('#secKPIs .kpi-emp').forEach(el=>{
    el.addEventListener('click', ()=>{
      document.querySelectorAll('#secKPIs .kpi-emp').forEach(x=>x.classList.remove('active'));
      el.classList.add('active');
      state.ui.empresa = el.dataset.empresa || '';
      renderKPIs();
    });
  });
  const kv=document.getElementById('kpiSelVendedor');
  const kg=document.getElementById('kpiSelGestor');
  const kp=document.getElementById('kpiSelProvincia');
  const kd=document.getElementById('kpiFDesde');
  const kh=document.getElementById('kpiFHasta');
  if(kv){ kv.addEventListener('change', ()=>{ state.ui.ven = kv.value||''; renderKPIs(); }); }
  if(kg){ kg.addEventListener('change', ()=>{ state.ui.ges = kg.value||''; renderKPIs(); }); }
  if(kp){ kp.addEventListener('change', ()=>{ state.ui.prov = kp.value||''; renderKPIs(); }); }
  if(kd){ kd.addEventListener('change', ()=>{ state.ui.desde = kd.value||''; renderKPIs(); }); }
  if(kh){ kh.addEventListener('change', ()=>{ state.ui.hasta = kh.value||''; renderKPIs(); }); }
}
function bindTabs(){
  document.querySelectorAll('nav .tab[data-section]').forEach(btn=>btn.addEventListener('click',()=>{
    document.querySelectorAll('nav .tab[data-section]').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const id=btn.dataset.section;
    document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    if(id==='secKPIs') renderKPIs();
    if(id==='secDespachos'){ setTimeout(()=>{ updateMiniMap(); }, 100); }
  }));
}
function bindDespachos(){
  // filtros planner
  ['dpSelVendedor','dpSelGestor','dpSelProvincia','dpFechaPedido'].forEach(id=>{
    const el=document.getElementById(id); if(el){ el.addEventListener('change', ()=>{ buildDespPedidosList(); }); }
  });
  // seleccionar visibles / limpiar
  document.getElementById('dpSelAll').addEventListener('click',()=>{
    document.querySelectorAll('#despPedidos input[type=checkbox]').forEach(ch=>{ ch.checked=true; });
    updatePlannerSummary();
  });
  document.getElementById('dpClearSel').addEventListener('click',()=>{
    document.querySelectorAll('#despPedidos input[type=checkbox]').forEach(ch=>{ ch.checked=false; });
    updatePlannerSummary();
  });
  document.getElementById('despPedidos').addEventListener('change', (e)=>{
    if(e.target && e.target.matches('input[type=checkbox]')) updatePlannerSummary();
  });
  // Crear despacho
  document.getElementById('btnCrearDespacho').addEventListener('click', async ()=>{
    const fecha=document.getElementById('despFecha').value;
    const gestor=document.getElementById('despGestor').value;
    const chofer=document.getElementById('despChofer').value;
    const veh=document.getElementById('despVehiculo').value;
    const vent=document.getElementById('despVentana').value;
    const checks=[...document.querySelectorAll('#despPedidos input[type=checkbox]:checked')];
    const pedidos=checks.map(ch=>ch.getAttribute('data-pid')).filter(x=>x);
    if(!fecha || !gestor || !chofer || !veh || !pedidos.length){ toast('Complete Fecha, Gestor, Chofer, Vehículo y seleccione pedidos.'); return; }
    const ruta_id = createUUID();
    const rec={ fecha, ruta_id, gestor, chofer, vehiculo:veh, ventana:vent, pedidos, estado_ruta:'Programado' };
    state.despachos.unshift(rec);
    buildDespachosList();
    addAudit('planner','create','ruta',ruta_id,rec);
    if(CONFIG.write.mode==='apps_script'){
      try{ await postAppsScript('Despachos', rec); toast('Despacho enviado a Sheets'); }
      catch(e){ toast('No se pudo enviar a Sheets: '+e.message); }
    }
  });
  document.getElementById('btnExportDespachos').addEventListener('click',()=>{
    if(!state.despachos.length){ toast('No hay despachos para exportar'); return; }
    // expandir con totales y provincias
    const expanded = state.despachos.map(r=>{
      const provs = [...new Set(r.pedidos.map(id=>{
        const p = state.pedidos.find(x=>String(x.id)===String(id));
        return p ? (p.provincia||'') : '';
      }).filter(Boolean))].join(', ');
      const totB = r.pedidos.reduce((s,id)=>{ const p=state.pedidos.find(x=>String(x.id)===String(id)); return s + (p?.bultos||0); },0);
      const totM = r.pedidos.reduce((s,id)=>{ const p=state.pedidos.find(x=>String(x.id)===String(id)); return s + (p?.valor||0); },0);
      return {...r, provincias:provs, pedidos_count:r.pedidos.length, bultos_total:totB, monto_total:totM};
    });
    downloadCSV('Despachos.csv', expanded);
  });
}
function bindConfig(){
  try{
    const saved=JSON.parse(localStorage.getItem('l360cfg')||'{}');
    if(saved.write){ CONFIG.write = saved.write; }
  }catch{}
  document.getElementById('cfgWriteMode').value = CONFIG.write.mode;
  document.getElementById('cfgAppsUrl').value = CONFIG.write.appsScriptUrl||'';
  document.getElementById('btnSaveConfig').addEventListener('click',()=>{
    CONFIG.write.mode = document.getElementById('cfgWriteMode').value;
    CONFIG.write.appsScriptUrl = document.getElementById('cfgAppsUrl').value;
    localStorage.setItem('l360cfg', JSON.stringify({write:CONFIG.write}));
    document.getElementById('cfgMsg').textContent = 'Guardado.';
  });
  document.getElementById('btnPing').addEventListener('click', async ()=>{
    try{
      await postAppsScript('Ping',{hello:true});
      document.getElementById('cfgMsg').textContent='Conexión OK';
    }catch(e){
      document.getElementById('cfgMsg').textContent='Error: '+e.message;
    }
  });
}
window.addEventListener('DOMContentLoaded', async ()=>{
  // Nav binds + global
  document.getElementById('refreshBtn').addEventListener('click', async ()=>{ await loadData(); toast('Datos actualizados'); });
  // Tabs
  bindTabs();
  // Pedidos/KPIs/Despachos/etc
  bindPedidosUI();
  bindKPIs();
  bindDespachos();
  bindConfig();
  // Init main map before load so container exists
  setTimeout(()=>{ initMap(); }, 50);
  await loadData();
  renderAll(); refreshPlanner();
});
</script>

</body>
</html>
